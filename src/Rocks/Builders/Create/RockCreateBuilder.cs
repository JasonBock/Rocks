using Microsoft.CodeAnalysis.Text;
using Rocks.Extensions;
using Rocks.Models;
using System.CodeDom.Compiler;
using System.Text;

namespace Rocks.Builders.Create;

internal sealed class RockCreateBuilder
{
	internal RockCreateBuilder(TypeMockModel mockType)
	{
		this.MockType = mockType;
		(this.Name, this.Text) = this.Build();
	}

	private (string, SourceText) Build()
	{
		using var writer = new StringWriter();
		using var indentWriter = new IndentedTextWriter(writer, "\t");

		var mockNamespace = this.MockType.Type.Namespace;

		if (mockNamespace.Length > 0)
		{
			indentWriter.WriteLine($"namespace {mockNamespace}");
			indentWriter.WriteLine("{");
			indentWriter.Indent++;
		}

		// TODO: I'm not sure these need to be added anymore.
		// Should try to remove these and see what happens.
		var requiredNamespaces = new SortedSet<string>
		{
			"using Rocks.Extensions;",
			"using System.Collections.Generic;",
			"using System.Collections.Immutable;",
		};

		var wereTypesProjected = MockBuilder.Build(indentWriter, this.MockType);

		if (wereTypesProjected)
		{
			requiredNamespaces.Add($"using {(mockNamespace.Length > 0 ? $"{mockNamespace}." : string.Empty)}ProjectionsFor{this.MockType.Type.FlattenedName};");
		}

		if (mockNamespace.Length > 0)
		{
			indentWriter.Indent--;
			indentWriter.Write("}");
		}

		var content = new List<string>
		{
			"// <auto-generated/>", string.Empty,
			"#nullable enable", string.Empty
		};

		if (this.MockType.Aliases.Length > 0)
		{
			var requiredAliases = this.MockType.Aliases
				.Select(_ => $"extern alias {_};").ToArray();
			content.AddRange([string.Join(Environment.NewLine, requiredAliases), string.Empty]);
		}

		content.AddRange([string.Join(Environment.NewLine, requiredNamespaces), string.Empty, writer.ToString()]);

		var text = SourceText.From(
			string.Join(Environment.NewLine, content),
			Encoding.UTF8);
		var name = $"{this.MockType.Type.FullyQualifiedName.GenerateFileName()}_Rock_Create.g.cs";
		return (name, text);
	}

	public string Name { get; private set; }
	public SourceText Text { get; private set; }
	private TypeMockModel MockType { get; }
}