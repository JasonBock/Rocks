using NUnit.Framework;

namespace Rocks.Analysis.Tests.Generators;

public static class OpenGenericsGeneratorTests
{
	[Test]
	public static async Task GenerateWithExplicitImplementationsAsync()
	{
		var code =
			"""
			using Rocks;
			using System;
			using System.Diagnostics.CodeAnalysis;
						
			[assembly: Rock(typeof(IRequest<,,>), BuildType.Create | BuildType.Make)]
			
			#nullable enable
			
			public interface IRequestSettings<TResponse>
				where TResponse : class 
			{ }

			public interface IRequest<TResponse>
				where TResponse : class
			{
				IRequestSettings<TResponse> Settings { get; }
			}			
			
			public interface IRequestSettings<TResponse, TResponse2>
				: IRequestSettings<TResponse>
				where TResponse : class 
				where TResponse2 : class
			{ }
			
			public interface IRequest<TResponse, TResponse2>
				: IRequest<TResponse>
				where TResponse : class
				where TResponse2 : class
			{
				new IRequestSettings<TResponse, TResponse2> Settings { get; }
			}			
			
			public interface IRequestSettings<TResponse, TResponse2, TResponse3>
				: IRequestSettings<TResponse, TResponse2>
				where TResponse : class 
				where TResponse2 : class
				where TResponse3 : class
			{ }
			
			public interface IRequest<TResponse, TResponse2, TResponse3>
				: IRequest<TResponse, TResponse2>
				where TResponse : class
				where TResponse2 : class
				where TResponse3 : class
			{
				new IRequestSettings<TResponse, TResponse2, TResponse3> Settings { get; }
			}
			""";

		var createGeneratedCode =
			""""
			// <auto-generated/>
			
			#pragma warning disable CS8618
			#pragma warning disable CS8633
			#pragma warning disable CS8714
			#pragma warning disable CS8775
			
			#nullable enable
			
			using Rocks.Extensions;
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			internal sealed class IRequestCreateExpectations<TResponse, TResponse2, TResponse3>
				: global::Rocks.Expectations
				where TResponse : class
				where TResponse2 : class
				where TResponse3 : class
			{
				private readonly global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3>.SetupsExpectations setups;
				
				internal sealed class SetupsExpectations
				{
					private readonly global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3> parent;
				
					internal SetupsExpectations(global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3> parent) =>
						this.parent = parent;
				
					internal sealed class SettingsPropertyExpectations
					{
						private readonly global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3> parent;
					
						internal SettingsPropertyExpectations(global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3> parent) => 
							this.parent = parent;
					
						internal global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3>.Adornments.AdornmentsForHandler0 Gets()
						{
							global::Rocks.Exceptions.ExpectationException.ThrowIf(this.parent.WasInstanceInvoked);
							var handler = new global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3>.Handler0();
							if (this.parent.handlers0 is null) { this.parent.handlers0 = new(handler); }
							else { this.parent.handlers0.Add(handler); }
							return new(handler);
						}
					}
					
					internal global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3>.SetupsExpectations.SettingsPropertyExpectations Settings => new(this.parent);
					
					internal sealed class ExplicitForIRequest0Expectations
					{
						private readonly global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3> parent;
					
						internal ExplicitForIRequest0Expectations(global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3> parent) =>
							this.parent = parent;
					
						internal sealed class SettingsPropertyExpectations
						{
							private readonly global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3> parent;
						
							internal SettingsPropertyExpectations(global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3> parent) => 
								this.parent = parent;
						
							internal global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3>.Adornments.AdornmentsForHandler1 Gets()
							{
								global::Rocks.Exceptions.ExpectationException.ThrowIf(this.parent.WasInstanceInvoked);
								var handler = new global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3>.Handler1();
								if (this.parent.handlers1 is null) { this.parent.handlers1 = new(handler); }
								else { this.parent.handlers1.Add(handler); }
								return new(handler);
							}
						}
						
						internal global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3>.SetupsExpectations.ExplicitForIRequest0Expectations.SettingsPropertyExpectations Settings => new(this.parent);
						
					}
					
					internal global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3>.SetupsExpectations.ExplicitForIRequest0Expectations ExplicitForIRequest0 => new(this.parent);
					
					internal sealed class ExplicitForIRequest1Expectations
					{
						private readonly global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3> parent;
					
						internal ExplicitForIRequest1Expectations(global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3> parent) =>
							this.parent = parent;
					
						internal sealed class SettingsPropertyExpectations
						{
							private readonly global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3> parent;
						
							internal SettingsPropertyExpectations(global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3> parent) => 
								this.parent = parent;
						
							internal global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3>.Adornments.AdornmentsForHandler2 Gets()
							{
								global::Rocks.Exceptions.ExpectationException.ThrowIf(this.parent.WasInstanceInvoked);
								var handler = new global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3>.Handler2();
								if (this.parent.handlers2 is null) { this.parent.handlers2 = new(handler); }
								else { this.parent.handlers2.Add(handler); }
								return new(handler);
							}
						}
						
						internal global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3>.SetupsExpectations.ExplicitForIRequest1Expectations.SettingsPropertyExpectations Settings => new(this.parent);
						
					}
					
					internal global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3>.SetupsExpectations.ExplicitForIRequest1Expectations ExplicitForIRequest1 => new(this.parent);
				}
				
				internal global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3>.SetupsExpectations Setups => this.setups;
				
				internal sealed class Handler0
					: global::Rocks.Handler<global::System.Func<global::IRequestSettings<TResponse, TResponse2, TResponse3>>, global::IRequestSettings<TResponse, TResponse2, TResponse3>>
				{ }
				private global::Rocks.Handlers<global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3>.Handler0>? @handlers0;
				
				internal sealed class Handler1
					: global::Rocks.Handler<global::System.Func<global::IRequestSettings<TResponse, TResponse2>>, global::IRequestSettings<TResponse, TResponse2>>
				{ }
				private global::Rocks.Handlers<global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3>.Handler1>? @handlers1;
				
				internal sealed class Handler2
					: global::Rocks.Handler<global::System.Func<global::IRequestSettings<TResponse>>, global::IRequestSettings<TResponse>>
				{ }
				private global::Rocks.Handlers<global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3>.Handler2>? @handlers2;
				
				public override void Verify()
				{
					if (!this.WasInstanceInvoked)
					{
						throw new global::Rocks.Exceptions.VerificationException([$"An instance of global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3> was never made."]);
					}
					else if (!this.WasExceptionThrown)
					{
						var failures = new global::System.Collections.Generic.List<string>();
				
						if (this.handlers0 is not null) { failures.AddRange(this.Verify(this.handlers0, 0)); }
						if (this.handlers1 is not null) { failures.AddRange(this.Verify(this.handlers1, 1)); }
						if (this.handlers2 is not null) { failures.AddRange(this.Verify(this.handlers2, 2)); }
				
						if (failures.Count > 0)
						{
							throw new global::Rocks.Exceptions.VerificationException(failures);
						}
					}
				}
				
				private sealed class Mock
					: global::IRequest<TResponse, TResponse2, TResponse3>
				{
					public Mock(global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3> @expectations)
					{
						this.Expectations = @expectations;
					}
					
					public global::IRequestSettings<TResponse, TResponse2, TResponse3> Settings
					{
						[global::Rocks.MemberIdentifier(0)]
						get
						{
							if (this.Expectations.handlers0 is not null)
							{
								var @handler = this.Expectations.handlers0.First;
								@handler.CallCount++;
								var @result = @handler.Callback is not null ?
									@handler.Callback() : @handler.ReturnValue;
								return @result!;
							}
							
							this.Expectations.WasExceptionThrown = true;
							throw new global::Rocks.Exceptions.ExpectationException(
								$"""
								No handlers match for {this.GetType().GetMemberDescription(0)}
								""");
						}
					}
					global::IRequestSettings<TResponse, TResponse2> global::IRequest<TResponse, TResponse2>.Settings
					{
						[global::Rocks.MemberIdentifier(1)]
						get
						{
							if (this.Expectations.handlers1 is not null)
							{
								var @handler = this.Expectations.handlers1.First;
								@handler.CallCount++;
								var @result = @handler.Callback is not null ?
									@handler.Callback() : @handler.ReturnValue;
								return @result!;
							}
							
							this.Expectations.WasExceptionThrown = true;
							throw new global::Rocks.Exceptions.ExpectationException(
								$"""
								No handlers match for {this.GetType().GetMemberDescription(1)}
								""");
						}
					}
					global::IRequestSettings<TResponse> global::IRequest<TResponse>.Settings
					{
						[global::Rocks.MemberIdentifier(2)]
						get
						{
							if (this.Expectations.handlers2 is not null)
							{
								var @handler = this.Expectations.handlers2.First;
								@handler.CallCount++;
								var @result = @handler.Callback is not null ?
									@handler.Callback() : @handler.ReturnValue;
								return @result!;
							}
							
							this.Expectations.WasExceptionThrown = true;
							throw new global::Rocks.Exceptions.ExpectationException(
								$"""
								No handlers match for {this.GetType().GetMemberDescription(2)}
								""");
						}
					}
					
					private global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3> Expectations { get; }
				}
				
				public IRequestCreateExpectations() => this.setups = new(this);
				
				internal global::IRequest<TResponse, TResponse2, TResponse3> Instance()
				{
					if (!this.WasInstanceInvoked)
					{
						this.WasInstanceInvoked = true;
						var @mock = new Mock(this);
						this.MockType = @mock.GetType();
						return @mock;
					}
					else
					{
						throw new global::Rocks.Exceptions.NewMockInstanceException("Can only create a new mock once.");
					}
				}
				
				internal static class Adornments
				{
					public interface IAdornmentsForIRequest<TAdornments>
						: global::Rocks.IAdornments<TAdornments>
						where TAdornments : IAdornmentsForIRequest<TAdornments>
					{ }
					
					public sealed class AdornmentsForHandler0
						: global::Rocks.Adornments<AdornmentsForHandler0, global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3>.Handler0, global::System.Func<global::IRequestSettings<TResponse, TResponse2, TResponse3>>, global::IRequestSettings<TResponse, TResponse2, TResponse3>>, IAdornmentsForIRequest<AdornmentsForHandler0>
					{
						public AdornmentsForHandler0(global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3>.Handler0 handler)
							: base(handler) { }
					}
					
					public sealed class AdornmentsForHandler1
						: global::Rocks.Adornments<AdornmentsForHandler1, global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3>.Handler1, global::System.Func<global::IRequestSettings<TResponse, TResponse2>>, global::IRequestSettings<TResponse, TResponse2>>, IAdornmentsForIRequest<AdornmentsForHandler1>
					{
						public AdornmentsForHandler1(global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3>.Handler1 handler)
							: base(handler) { }
					}
					
					public sealed class AdornmentsForHandler2
						: global::Rocks.Adornments<AdornmentsForHandler2, global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3>.Handler2, global::System.Func<global::IRequestSettings<TResponse>>, global::IRequestSettings<TResponse>>, IAdornmentsForIRequest<AdornmentsForHandler2>
					{
						public AdornmentsForHandler2(global::IRequestCreateExpectations<TResponse, TResponse2, TResponse3>.Handler2 handler)
							: base(handler) { }
					}
				}
			}
			
			#pragma warning restore CS8618
			#pragma warning restore CS8633
			#pragma warning restore CS8714
			#pragma warning restore CS8775
			"""";

		var makeGeneratedCode =
			""""
			// <auto-generated/>
			
			#pragma warning disable CS8618
			#pragma warning disable CS8633
			#pragma warning disable CS8714
			#pragma warning disable CS8775
			
			#nullable enable
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			internal sealed class IRequestMakeExpectations<TResponse, TResponse2, TResponse3>
				where TResponse : class
				where TResponse2 : class
				where TResponse3 : class
			{
				internal global::IRequest<TResponse, TResponse2, TResponse3> Instance()
				{
					return new Mock();
				}
				
				private sealed class Mock
					: global::IRequest<TResponse, TResponse2, TResponse3>
				{
					public Mock()
					{
					}
					
					public global::IRequestSettings<TResponse, TResponse2, TResponse3> Settings
					{
						get => default!;
					}
					
					global::IRequestSettings<TResponse, TResponse2> global::IRequest<TResponse, TResponse2>.Settings
					{
						get => default!;
					}
					
					global::IRequestSettings<TResponse> global::IRequest<TResponse>.Settings
					{
						get => default!;
					}
				}
			}
			
			#pragma warning restore CS8618
			#pragma warning restore CS8633
			#pragma warning restore CS8714
			#pragma warning restore CS8775
			
			"""";

		await TestAssistants.RunGeneratorAsync<RockGenerator>(code,
			[
				("IRequestTResponse, TResponse2, TResponse3_Rock_Create.g.cs", createGeneratedCode),
				("IRequestTResponse, TResponse2, TResponse3_Rock_Make.g.cs", makeGeneratedCode)
			],
			[]);
	}

	[Test]
	public static async Task GenerateWhenNullableOpenGenericsExistAsync()
	{
		var code =
			"""
			using Rocks;
			using System;
			using System.Diagnostics.CodeAnalysis;
						
			[assembly: Rock(typeof(IConsumerContext<>), BuildType.Create | BuildType.Make)]
			
			#nullable enable
			
			public interface IPipeContext
			{
				bool TryGetPayload<T>([NotNullWhen(true)] out T? payload) where T : class;
			}

			public interface IConsumerContext<out T> :
				IPipeContext
				where T : class
			{
				void Consume(string message);
			}
			""";

		var createGeneratedCode =
			""""
			// <auto-generated/>
			
			#pragma warning disable CS8618
			#pragma warning disable CS8633
			#pragma warning disable CS8714
			#pragma warning disable CS8775
			
			#nullable enable
			
			using Rocks.Extensions;
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			internal sealed class IConsumerContextCreateExpectations<T>
				: global::Rocks.Expectations
				where T : class
			{
				private readonly global::IConsumerContextCreateExpectations<T>.SetupsExpectations setups;
				
				internal sealed class SetupsExpectations
				{
					private readonly global::IConsumerContextCreateExpectations<T> parent;
				
					internal SetupsExpectations(global::IConsumerContextCreateExpectations<T> parent) =>
						this.parent = parent;
				
					internal global::IConsumerContextCreateExpectations<T>.Adornments.AdornmentsForHandler0 Consume(global::Rocks.Argument<string> @message)
					{
						global::Rocks.Exceptions.ExpectationException.ThrowIf(this.parent.WasInstanceInvoked);
						global::System.ArgumentNullException.ThrowIfNull(@message);
						
						var @handler = new global::IConsumerContextCreateExpectations<T>.Handler0
						{
							@message = @message,
						};
						
						if (this.parent.handlers0 is null) { this.parent.handlers0 = new(@handler); }
						else { this.parent.handlers0.Add(@handler); }
						return new(@handler);
					}
					
					internal global::IConsumerContextCreateExpectations<T>.Adornments.AdornmentsForHandler1<T1> TryGetPayload<T1>(global::Rocks.Argument<T1?> @payload) where T1 : class
					{
						global::Rocks.Exceptions.ExpectationException.ThrowIf(this.parent.WasInstanceInvoked);
						global::System.ArgumentNullException.ThrowIfNull(@payload);
						
						var @handler = new global::IConsumerContextCreateExpectations<T>.Handler1<T1>
						{
							@payload = global::Rocks.Arg.Any<T1?>(),
						};
						
						if (this.parent.handlers1 is null) { this.parent.handlers1 = new(@handler); }
						else { this.parent.handlers1.Add(@handler); }
						return new(@handler);
					}
				}
				
				internal global::IConsumerContextCreateExpectations<T>.SetupsExpectations Setups => this.setups;
				
				internal sealed class Handler0
					: global::Rocks.Handler<global::System.Action<string>>
				{
					public global::Rocks.Argument<string> @message { get; set; }
				}
				private global::Rocks.Handlers<global::IConsumerContextCreateExpectations<T>.Handler0>? @handlers0;
				
				internal sealed class Handler1<T1>
					: global::Rocks.Handler<Handler1<T1>.CallbackForHandler, bool>
					where T1 : class
				{
					internal delegate bool CallbackForHandler([global::System.Diagnostics.CodeAnalysis.NotNullWhenAttribute(true)]out T1? @payload);
					public global::Rocks.Argument<T1?> @payload { get; set; }
				}
				private global::Rocks.Handlers<global::Rocks.Handler>? @handlers1;
				
				public override void Verify()
				{
					if (!this.WasInstanceInvoked)
					{
						throw new global::Rocks.Exceptions.VerificationException([$"An instance of global::IConsumerContextCreateExpectations<T> was never made."]);
					}
					else if (!this.WasExceptionThrown)
					{
						var failures = new global::System.Collections.Generic.List<string>();
				
						if (this.handlers0 is not null) { failures.AddRange(this.Verify(this.handlers0, 0)); }
						if (this.handlers1 is not null) { failures.AddRange(this.Verify(this.handlers1, 1)); }
				
						if (failures.Count > 0)
						{
							throw new global::Rocks.Exceptions.VerificationException(failures);
						}
					}
				}
				
				private sealed class Mock
					: global::IConsumerContext<T>
				{
					public Mock(global::IConsumerContextCreateExpectations<T> @expectations)
					{
						this.Expectations = @expectations;
					}
					
					[global::Rocks.MemberIdentifier(0)]
					public void Consume(string @message)
					{
						if (this.Expectations.handlers0 is not null)
						{
							var @foundMatch = false;
							
							foreach (var @handler in this.Expectations.handlers0)
							{
								if (@handler.@message.IsValid(@message!))
								{
									@foundMatch = true;
									@handler.CallCount++;
									@handler.Callback?.Invoke(@message!);
									break;
								}
							}
							
							if (!@foundMatch)
							{
								this.Expectations.WasExceptionThrown = true;
								throw new global::Rocks.Exceptions.ExpectationException(
									$"""
									No handlers match for {this.GetType().GetMemberDescription(0)}
										message: {@message.FormatValue()}
									""");
							}
						}
						else
						{
							this.Expectations.WasExceptionThrown = true;
							throw new global::Rocks.Exceptions.ExpectationException(
								$"""
								No handlers were found for {this.GetType().GetMemberDescription(0)}
									message: {@message.FormatValue()}
								""");
						}
					}
					
					[global::Rocks.MemberIdentifier(1)]
					public bool TryGetPayload<T1>([global::System.Diagnostics.CodeAnalysis.NotNullWhenAttribute(true)] out T1? @payload)
						where T1 : class
					{
						@payload = default!;
						if (this.Expectations.handlers1 is not null)
						{
							foreach (var @genericHandler in this.Expectations.handlers1)
							{
								if (@genericHandler is global::IConsumerContextCreateExpectations<T>.Handler1<T1> @handler)
								{
									if (@handler.@payload.IsValid(@payload!))
									{
										@handler.CallCount++;
										var @result = @handler.Callback is not null ?
											@handler.Callback(out @payload!) : @handler.ReturnValue;
										return @result!;
									}
								}
							}
							
							this.Expectations.WasExceptionThrown = true;
							throw new global::Rocks.Exceptions.ExpectationException(
								$"""
								No handlers match for {this.GetType().GetMemberDescription(1)}
									payload: {@payload.FormatValue()}
								""");
						}
						
						this.Expectations.WasExceptionThrown = true;
						throw new global::Rocks.Exceptions.ExpectationException(
							$"""
							No handlers were found for {this.GetType().GetMemberDescription(1)}
								payload: {@payload.FormatValue()}
							""");
					}
					
					private global::IConsumerContextCreateExpectations<T> Expectations { get; }
				}
				
				public IConsumerContextCreateExpectations() => this.setups = new(this);
				
				internal global::IConsumerContext<T> Instance()
				{
					if (!this.WasInstanceInvoked)
					{
						this.WasInstanceInvoked = true;
						var @mock = new Mock(this);
						this.MockType = @mock.GetType();
						return @mock;
					}
					else
					{
						throw new global::Rocks.Exceptions.NewMockInstanceException("Can only create a new mock once.");
					}
				}
				
				internal static class Adornments
				{
					public interface IAdornmentsForIConsumerContext<TAdornments>
						: global::Rocks.IAdornments<TAdornments>
						where TAdornments : IAdornmentsForIConsumerContext<TAdornments>
					{ }
					
					public sealed class AdornmentsForHandler0
						: global::Rocks.Adornments<AdornmentsForHandler0, global::IConsumerContextCreateExpectations<T>.Handler0, global::System.Action<string>>, IAdornmentsForIConsumerContext<AdornmentsForHandler0>
					{
						public AdornmentsForHandler0(global::IConsumerContextCreateExpectations<T>.Handler0 handler)
							: base(handler) { }
					}
					
					public sealed class AdornmentsForHandler1<T1>
						: global::Rocks.Adornments<AdornmentsForHandler1<T1>, global::IConsumerContextCreateExpectations<T>.Handler1<T1>, global::IConsumerContextCreateExpectations<T>.Handler1<T1>.CallbackForHandler, bool>, IAdornmentsForIConsumerContext<AdornmentsForHandler1<T1>> where T1 : class
					{
						public AdornmentsForHandler1(global::IConsumerContextCreateExpectations<T>.Handler1<T1> handler)
							: base(handler) { }
					}
				}
			}
			
			#pragma warning restore CS8618
			#pragma warning restore CS8633
			#pragma warning restore CS8714
			#pragma warning restore CS8775
			"""";

		var makeGeneratedCode =
			""""
			// <auto-generated/>
			
			#pragma warning disable CS8618
			#pragma warning disable CS8633
			#pragma warning disable CS8714
			#pragma warning disable CS8775
			
			#nullable enable
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			internal sealed class IConsumerContextMakeExpectations<T>
				where T : class
			{
				internal global::IConsumerContext<T> Instance()
				{
					return new Mock();
				}
				
				private sealed class Mock
					: global::IConsumerContext<T>
				{
					public Mock()
					{
					}
					
					public void Consume(string @message)
					{
					}
					
					public bool TryGetPayload<T1>([global::System.Diagnostics.CodeAnalysis.NotNullWhenAttribute(true)] out T1? @payload)
						where T1 : class
					{
						@payload = default!;
						return default!;
					}
				}
			}
			
			#pragma warning restore CS8618
			#pragma warning restore CS8633
			#pragma warning restore CS8714
			#pragma warning restore CS8775
			
			"""";

		await TestAssistants.RunGeneratorAsync<RockGenerator>(code,
			[
				("IConsumerContextT_Rock_Create.g.cs", createGeneratedCode),
				("IConsumerContextT_Rock_Make.g.cs", makeGeneratedCode)
			],
			[]);
	}

	[Test]
	public static async Task GenerateWhenEventExistsAsync()
	{
		var code =
			"""
			using Rocks;
			using System;
			
			[assembly: Rock(typeof(IService<>), BuildType.Create | BuildType.Make)]
			
			#nullable enable

			public interface IService<T>
			{
				void Run(T value);

				event EventHandler MyEvent;
			}
			""";

		var createGeneratedCode =
			""""
			// <auto-generated/>
			
			#pragma warning disable CS8618
			#pragma warning disable CS8633
			#pragma warning disable CS8714
			#pragma warning disable CS8775
			
			#nullable enable
			
			using Rocks.Extensions;
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			internal sealed class IServiceCreateExpectations<T>
				: global::Rocks.Expectations
			{
				private readonly global::IServiceCreateExpectations<T>.SetupsExpectations setups;
				
				internal sealed class SetupsExpectations
				{
					private readonly global::IServiceCreateExpectations<T> parent;
				
					internal SetupsExpectations(global::IServiceCreateExpectations<T> parent) =>
						this.parent = parent;
				
					internal global::IServiceCreateExpectations<T>.Adornments.AdornmentsForHandler0 Run(global::Rocks.Argument<T> @value)
					{
						global::Rocks.Exceptions.ExpectationException.ThrowIf(this.parent.WasInstanceInvoked);
						global::System.ArgumentNullException.ThrowIfNull(@value);
						
						var @handler = new global::IServiceCreateExpectations<T>.Handler0
						{
							@value = @value,
						};
						
						if (this.parent.handlers0 is null) { this.parent.handlers0 = new(@handler); }
						else { this.parent.handlers0.Add(@handler); }
						return new(@handler);
					}
				}
				
				internal global::IServiceCreateExpectations<T>.SetupsExpectations Setups => this.setups;
				
				internal sealed class Handler0
					: global::Rocks.Handler<global::System.Action<T>>
				{
					public global::Rocks.Argument<T> @value { get; set; }
				}
				private global::Rocks.Handlers<global::IServiceCreateExpectations<T>.Handler0>? @handlers0;
				
				public override void Verify()
				{
					if (!this.WasInstanceInvoked)
					{
						throw new global::Rocks.Exceptions.VerificationException([$"An instance of global::IServiceCreateExpectations<T> was never made."]);
					}
					else if (!this.WasExceptionThrown)
					{
						var failures = new global::System.Collections.Generic.List<string>();
				
						if (this.handlers0 is not null) { failures.AddRange(this.Verify(this.handlers0, 0)); }
				
						if (failures.Count > 0)
						{
							throw new global::Rocks.Exceptions.VerificationException(failures);
						}
					}
				}
				
				private sealed class Mock
					: global::IService<T>, global::Rocks.IRaiseEvents
				{
					public Mock(global::IServiceCreateExpectations<T> @expectations)
					{
						this.Expectations = @expectations;
					}
					
					[global::Rocks.MemberIdentifier(0)]
					public void Run(T @value)
					{
						if (this.Expectations.handlers0 is not null)
						{
							var @foundMatch = false;
							
							foreach (var @handler in this.Expectations.handlers0)
							{
								if (@handler.@value.IsValid(@value!))
								{
									@foundMatch = true;
									@handler.CallCount++;
									@handler.Callback?.Invoke(@value!);
									@handler.RaiseEvents(this);
									break;
								}
							}
							
							if (!@foundMatch)
							{
								this.Expectations.WasExceptionThrown = true;
								throw new global::Rocks.Exceptions.ExpectationException(
									$"""
									No handlers match for {this.GetType().GetMemberDescription(0)}
										value: {@value.FormatValue()}
									""");
							}
						}
						else
						{
							this.Expectations.WasExceptionThrown = true;
							throw new global::Rocks.Exceptions.ExpectationException(
								$"""
								No handlers were found for {this.GetType().GetMemberDescription(0)}
									value: {@value.FormatValue()}
								""");
						}
					}
					
					#pragma warning disable CS0067
					public event global::System.EventHandler? MyEvent;
					#pragma warning restore CS0067
					
					void global::Rocks.IRaiseEvents.Raise(string @fieldName, object @args)
					{
						var @thisType = this.GetType();
						var @eventDelegate = (global::System.MulticastDelegate)thisType.GetField(@fieldName, 
							global::System.Reflection.BindingFlags.Instance | global::System.Reflection.BindingFlags.NonPublic)!.GetValue(this)!;
						
						if (@eventDelegate is not null)
						{
							foreach (var @handler in @eventDelegate.GetInvocationList())
							{
								@handler.Method.Invoke(@handler.Target, new object[]{this, @args});
							}
						}
					}
					
					private global::IServiceCreateExpectations<T> Expectations { get; }
				}
				
				public IServiceCreateExpectations() => this.setups = new(this);
				
				internal global::IService<T> Instance()
				{
					if (!this.WasInstanceInvoked)
					{
						this.WasInstanceInvoked = true;
						var @mock = new Mock(this);
						this.MockType = @mock.GetType();
						return @mock;
					}
					else
					{
						throw new global::Rocks.Exceptions.NewMockInstanceException("Can only create a new mock once.");
					}
				}
				
				internal static class Adornments
				{
					public interface IAdornmentsForIService<TAdornments>
						: global::Rocks.IAdornments<TAdornments>
						where TAdornments : IAdornmentsForIService<TAdornments>
					{ }
					
					public sealed class AdornmentsForHandler0
						: global::Rocks.Adornments<AdornmentsForHandler0, global::IServiceCreateExpectations<T>.Handler0, global::System.Action<T>>, IAdornmentsForIService<AdornmentsForHandler0>
					{
						public AdornmentsForHandler0(global::IServiceCreateExpectations<T>.Handler0 handler)
							: base(handler) { }
					}
				}
			}
			
			#pragma warning restore CS8618
			#pragma warning restore CS8633
			#pragma warning restore CS8714
			#pragma warning restore CS8775
			"""";

		var makeGeneratedCode =
			""""
			// <auto-generated/>
			
			#pragma warning disable CS8618
			#pragma warning disable CS8633
			#pragma warning disable CS8714
			#pragma warning disable CS8775
			
			#nullable enable
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			internal sealed class IServiceMakeExpectations<T>
			{
				internal global::IService<T> Instance()
				{
					return new Mock();
				}
				
				private sealed class Mock
					: global::IService<T>
				{
					public Mock()
					{
					}
					
					public void Run(T @value)
					{
					}
					
					#pragma warning disable CS0067
					public event global::System.EventHandler? MyEvent;
					#pragma warning restore CS0067
				}
			}
			
			#pragma warning restore CS8618
			#pragma warning restore CS8633
			#pragma warning restore CS8714
			#pragma warning restore CS8775
			
			"""";

		await TestAssistants.RunGeneratorAsync<RockGenerator>(code,
			[
				("IServiceT_Rock_Create.g.cs", createGeneratedCode),
				("IServiceT_Rock_Make.g.cs", makeGeneratedCode)
			],
			[]);
	}

	[Test]
	public static async Task GenerateAsync()
	{
		var code =
			"""
			using Rocks;
			using System;
			
			[assembly: Rock(typeof(IService<,>), BuildType.Create | BuildType.Make)]
			
			#nullable enable

			public interface IService<T, TReturn>
			{
				TReturn Service(T data);
			}
			""";

		var createGeneratedCode =
			""""
			// <auto-generated/>
			
			#pragma warning disable CS8618
			#pragma warning disable CS8633
			#pragma warning disable CS8714
			#pragma warning disable CS8775
			
			#nullable enable
			
			using Rocks.Extensions;
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			internal sealed class IServiceCreateExpectations<T, TReturn>
				: global::Rocks.Expectations
			{
				private readonly global::IServiceCreateExpectations<T, TReturn>.SetupsExpectations setups;
				
				internal sealed class SetupsExpectations
				{
					private readonly global::IServiceCreateExpectations<T, TReturn> parent;
				
					internal SetupsExpectations(global::IServiceCreateExpectations<T, TReturn> parent) =>
						this.parent = parent;
				
					internal global::IServiceCreateExpectations<T, TReturn>.Adornments.AdornmentsForHandler0 Service(global::Rocks.Argument<T> @data)
					{
						global::Rocks.Exceptions.ExpectationException.ThrowIf(this.parent.WasInstanceInvoked);
						global::System.ArgumentNullException.ThrowIfNull(@data);
						
						var @handler = new global::IServiceCreateExpectations<T, TReturn>.Handler0
						{
							@data = @data,
						};
						
						if (this.parent.handlers0 is null) { this.parent.handlers0 = new(@handler); }
						else { this.parent.handlers0.Add(@handler); }
						return new(@handler);
					}
				}
				
				internal global::IServiceCreateExpectations<T, TReturn>.SetupsExpectations Setups => this.setups;
				
				internal sealed class Handler0
					: global::Rocks.Handler<global::System.Func<T, TReturn>, TReturn>
				{
					public global::Rocks.Argument<T> @data { get; set; }
				}
				private global::Rocks.Handlers<global::IServiceCreateExpectations<T, TReturn>.Handler0>? @handlers0;
				
				public override void Verify()
				{
					if (!this.WasInstanceInvoked)
					{
						throw new global::Rocks.Exceptions.VerificationException([$"An instance of global::IServiceCreateExpectations<T, TReturn> was never made."]);
					}
					else if (!this.WasExceptionThrown)
					{
						var failures = new global::System.Collections.Generic.List<string>();
				
						if (this.handlers0 is not null) { failures.AddRange(this.Verify(this.handlers0, 0)); }
				
						if (failures.Count > 0)
						{
							throw new global::Rocks.Exceptions.VerificationException(failures);
						}
					}
				}
				
				private sealed class Mock
					: global::IService<T, TReturn>
				{
					public Mock(global::IServiceCreateExpectations<T, TReturn> @expectations)
					{
						this.Expectations = @expectations;
					}
					
					[global::Rocks.MemberIdentifier(0)]
					public TReturn Service(T @data)
					{
						if (this.Expectations.handlers0 is not null)
						{
							foreach (var @handler in this.Expectations.handlers0)
							{
								if (@handler.@data.IsValid(@data!))
								{
									@handler.CallCount++;
									var @result = @handler.Callback is not null ?
										@handler.Callback(@data!) : @handler.ReturnValue;
									return @result!;
								}
							}
							
							this.Expectations.WasExceptionThrown = true;
							throw new global::Rocks.Exceptions.ExpectationException(
								$"""
								No handlers match for {this.GetType().GetMemberDescription(0)}
									data: {@data.FormatValue()}
								""");
						}
						
						this.Expectations.WasExceptionThrown = true;
						throw new global::Rocks.Exceptions.ExpectationException(
							$"""
							No handlers were found for {this.GetType().GetMemberDescription(0)}
								data: {@data.FormatValue()}
							""");
					}
					
					private global::IServiceCreateExpectations<T, TReturn> Expectations { get; }
				}
				
				public IServiceCreateExpectations() => this.setups = new(this);
				
				internal global::IService<T, TReturn> Instance()
				{
					if (!this.WasInstanceInvoked)
					{
						this.WasInstanceInvoked = true;
						var @mock = new Mock(this);
						this.MockType = @mock.GetType();
						return @mock;
					}
					else
					{
						throw new global::Rocks.Exceptions.NewMockInstanceException("Can only create a new mock once.");
					}
				}
				
				internal static class Adornments
				{
					public interface IAdornmentsForIService<TAdornments>
						: global::Rocks.IAdornments<TAdornments>
						where TAdornments : IAdornmentsForIService<TAdornments>
					{ }
					
					public sealed class AdornmentsForHandler0
						: global::Rocks.Adornments<AdornmentsForHandler0, global::IServiceCreateExpectations<T, TReturn>.Handler0, global::System.Func<T, TReturn>, TReturn>, IAdornmentsForIService<AdornmentsForHandler0>
					{
						public AdornmentsForHandler0(global::IServiceCreateExpectations<T, TReturn>.Handler0 handler)
							: base(handler) { }
					}
				}
			}
			
			#pragma warning restore CS8618
			#pragma warning restore CS8633
			#pragma warning restore CS8714
			#pragma warning restore CS8775
			"""";

		var makeGeneratedCode =
			""""
			// <auto-generated/>
			
			#pragma warning disable CS8618
			#pragma warning disable CS8633
			#pragma warning disable CS8714
			#pragma warning disable CS8775
			
			#nullable enable
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			internal sealed class IServiceMakeExpectations<T, TReturn>
			{
				internal global::IService<T, TReturn> Instance()
				{
					return new Mock();
				}
				
				private sealed class Mock
					: global::IService<T, TReturn>
				{
					public Mock()
					{
					}
					
					public TReturn Service(T @data)
					{
						return default!;
					}
				}
			}
			
			#pragma warning restore CS8618
			#pragma warning restore CS8633
			#pragma warning restore CS8714
			#pragma warning restore CS8775
			
			"""";

		await TestAssistants.RunGeneratorAsync<RockGenerator>(code,
			[
				("IServiceT, TReturn_Rock_Create.g.cs", createGeneratedCode),
				("IServiceT, TReturn_Rock_Make.g.cs", makeGeneratedCode)
			],
			[]);
	}

	[Test]
	public static async Task GenerateWithPropertiesAndIndexersAsync()
	{
		var code =
			"""
			using Rocks;
			using System;
			
			[assembly: Rock(typeof(IService<,>), BuildType.Create | BuildType.Make)]
			
			#nullable enable

			public interface IService<T, TReturn>
			{
				T Data { get; set; }
				TReturn this[TReturn index] { get; set; }
			}
			""";

		var createGeneratedCode =
			""""
			// <auto-generated/>
			
			#pragma warning disable CS8618
			#pragma warning disable CS8633
			#pragma warning disable CS8714
			#pragma warning disable CS8775
			
			#nullable enable
			
			using Rocks.Extensions;
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			internal sealed class IServiceCreateExpectations<T, TReturn>
				: global::Rocks.Expectations
			{
				private readonly global::IServiceCreateExpectations<T, TReturn>.SetupsExpectations setups;
				
				internal sealed class SetupsExpectations
				{
					private readonly global::IServiceCreateExpectations<T, TReturn> parent;
				
					internal SetupsExpectations(global::IServiceCreateExpectations<T, TReturn> parent) =>
						this.parent = parent;
				
					internal sealed class DataPropertyExpectations
					{
						private readonly global::IServiceCreateExpectations<T, TReturn> parent;
					
						internal DataPropertyExpectations(global::IServiceCreateExpectations<T, TReturn> parent) => 
							this.parent = parent;
					
						internal global::IServiceCreateExpectations<T, TReturn>.Adornments.AdornmentsForHandler0 Gets()
						{
							global::Rocks.Exceptions.ExpectationException.ThrowIf(this.parent.WasInstanceInvoked);
							var handler = new global::IServiceCreateExpectations<T, TReturn>.Handler0();
							if (this.parent.handlers0 is null) { this.parent.handlers0 = new(handler); }
							else { this.parent.handlers0.Add(handler); }
							return new(handler);
						}
						internal global::IServiceCreateExpectations<T, TReturn>.Adornments.AdornmentsForHandler1 Sets(global::Rocks.Argument<T> @value)
						{
							global::Rocks.Exceptions.ExpectationException.ThrowIf(this.parent.WasInstanceInvoked);
							global::System.ArgumentNullException.ThrowIfNull(@value);
						
							var handler = new global::IServiceCreateExpectations<T, TReturn>.Handler1
							{
								value = @value,
							};
						
							if (this.parent.handlers1 is null) { this.parent.handlers1 = new(handler); }
							else { this.parent.handlers1.Add(handler); }
							return new(handler);
						}
					}
					
					internal global::IServiceCreateExpectations<T, TReturn>.SetupsExpectations.DataPropertyExpectations Data => new(this.parent);
					
					internal sealed class Indexer0Expectations
					{
						private readonly global::IServiceCreateExpectations<T, TReturn> @parent;
						private readonly global::Rocks.Argument<TReturn> @index;
						
						internal Indexer0Expectations(global::IServiceCreateExpectations<T, TReturn> @parent, global::Rocks.Argument<TReturn> @index)
						{
							global::System.ArgumentNullException.ThrowIfNull(@index);
							this.@parent = @parent;
							this.@index = @index;
						}
						
						internal global::IServiceCreateExpectations<T, TReturn>.Adornments.AdornmentsForHandler2 Gets()
						{
							global::Rocks.Exceptions.ExpectationException.ThrowIf(this.parent.WasInstanceInvoked);
							
							var @handler = new global::IServiceCreateExpectations<T, TReturn>.Handler2
							{
								@index = this.@index,
							};
							
							if (this.parent.handlers2 is null) { this.parent.handlers2 = new(@handler); }
							else { this.parent.handlers2.Add(@handler); }
							return new(@handler);
						}
						
						internal global::IServiceCreateExpectations<T, TReturn>.Adornments.AdornmentsForHandler3 Sets(global::Rocks.Argument<TReturn> @value)
						{
							global::Rocks.Exceptions.ExpectationException.ThrowIf(this.parent.WasInstanceInvoked);
							global::System.ArgumentNullException.ThrowIfNull(@value);
							
							var @handler = new global::IServiceCreateExpectations<T, TReturn>.Handler3
							{
								@index = this.@index,
								@value = @value,
							};
							
							if (this.parent.handlers3 is null) { this.parent.handlers3 = new(@handler); }
							else { this.parent.handlers3.Add(@handler); }
							return new(@handler);
						}
					}
					
					internal global::IServiceCreateExpectations<T, TReturn>.SetupsExpectations.Indexer0Expectations this[global::Rocks.Argument<TReturn> @index] => new(this.parent, @index);
					
				}
				
				internal global::IServiceCreateExpectations<T, TReturn>.SetupsExpectations Setups => this.setups;
				
				internal sealed class Handler0
					: global::Rocks.Handler<global::System.Func<T>, T>
				{ }
				private global::Rocks.Handlers<global::IServiceCreateExpectations<T, TReturn>.Handler0>? @handlers0;
				
				internal sealed class Handler1
					: global::Rocks.Handler<global::System.Action<T>>
				{
					public global::Rocks.Argument<T> @value { get; set; }
				}
				private global::Rocks.Handlers<global::IServiceCreateExpectations<T, TReturn>.Handler1>? @handlers1;
				
				internal sealed class Handler2
					: global::Rocks.Handler<global::System.Func<TReturn, TReturn>, TReturn>
				{
					public global::Rocks.Argument<TReturn> @index { get; set; }
				}
				private global::Rocks.Handlers<global::IServiceCreateExpectations<T, TReturn>.Handler2>? @handlers2;
				
				internal sealed class Handler3
					: global::Rocks.Handler<global::System.Action<TReturn, TReturn>>
				{
					public global::Rocks.Argument<TReturn> @index { get; set; }
					public global::Rocks.Argument<TReturn> @value { get; set; }
				}
				private global::Rocks.Handlers<global::IServiceCreateExpectations<T, TReturn>.Handler3>? @handlers3;
				
				public override void Verify()
				{
					if (!this.WasInstanceInvoked)
					{
						throw new global::Rocks.Exceptions.VerificationException([$"An instance of global::IServiceCreateExpectations<T, TReturn> was never made."]);
					}
					else if (!this.WasExceptionThrown)
					{
						var failures = new global::System.Collections.Generic.List<string>();
				
						if (this.handlers0 is not null) { failures.AddRange(this.Verify(this.handlers0, 0)); }
						if (this.handlers1 is not null) { failures.AddRange(this.Verify(this.handlers1, 1)); }
						if (this.handlers2 is not null) { failures.AddRange(this.Verify(this.handlers2, 2)); }
						if (this.handlers3 is not null) { failures.AddRange(this.Verify(this.handlers3, 3)); }
				
						if (failures.Count > 0)
						{
							throw new global::Rocks.Exceptions.VerificationException(failures);
						}
					}
				}
				
				private sealed class Mock
					: global::IService<T, TReturn>
				{
					public Mock(global::IServiceCreateExpectations<T, TReturn> @expectations)
					{
						this.Expectations = @expectations;
					}
					
					public T Data
					{
						[global::Rocks.MemberIdentifier(0)]
						get
						{
							if (this.Expectations.handlers0 is not null)
							{
								var @handler = this.Expectations.handlers0.First;
								@handler.CallCount++;
								var @result = @handler.Callback is not null ?
									@handler.Callback() : @handler.ReturnValue;
								return @result!;
							}
							
							this.Expectations.WasExceptionThrown = true;
							throw new global::Rocks.Exceptions.ExpectationException(
								$"""
								No handlers match for {this.GetType().GetMemberDescription(0)}
								""");
						}
						[global::Rocks.MemberIdentifier(1)]
						set
						{
							if (this.Expectations.handlers1 is not null)
							{
								var @foundMatch = false;
								foreach (var @handler in this.Expectations.handlers1)
								{
									if (@handler.value.IsValid(value!))
									{
										@handler.CallCount++;
										@foundMatch = true;
										@handler.Callback?.Invoke(value!);
										break;
									}
								}
						
								if (!@foundMatch)
								{
									this.Expectations.WasExceptionThrown = true;
									throw new global::Rocks.Exceptions.ExpectationException(
										$"""
										No handlers match for {this.GetType().GetMemberDescription(1)}
											value: {@value.FormatValue()}
										""");
								}
							}
							else
							{
								this.Expectations.WasExceptionThrown = true;
								throw new global::Rocks.Exceptions.ExpectationException(
									$"""
									No handlers were found for {this.GetType().GetMemberDescription(1)}
										value: {@value.FormatValue()}
									""");
							}
						}
					}
					
					public TReturn this[TReturn @index]
					{
						[global::Rocks.MemberIdentifier(2)]
						get
						{
							if (this.Expectations.handlers2 is not null)
							{
								foreach (var @handler in this.Expectations.handlers2)
								{
									if (@handler.@index.IsValid(@index!))
									{
										@handler.CallCount++;
										var @result = @handler.Callback is not null ?
											@handler.Callback(@index!) : @handler.ReturnValue;
										return @result!;
									}
								}
								
								this.Expectations.WasExceptionThrown = true;
								throw new global::Rocks.Exceptions.ExpectationException(
									$"""
									No handlers match for {this.GetType().GetMemberDescription(2)}
										index: {@index.FormatValue()}
									""");
							}
							
							this.Expectations.WasExceptionThrown = true;
							throw new global::Rocks.Exceptions.ExpectationException(
								$"""
								No handlers were found for {this.GetType().GetMemberDescription(2)}
									index: {@index.FormatValue()}
								""");
						}
						[global::Rocks.MemberIdentifier(3)]
						set
						{
							if (this.Expectations.handlers3 is not null)
							{
								foreach (var @handler in this.Expectations.handlers3)
								{
									if (@handler.@index.IsValid(@index!) &&
										@handler.@value.IsValid(@value!))
									{
										@handler.CallCount++;
										@handler.Callback?.Invoke(@index!, @value!);
										return;
									}
								}
								
								this.Expectations.WasExceptionThrown = true;
								throw new global::Rocks.Exceptions.ExpectationException(
									$"""
									No handlers match for {this.GetType().GetMemberDescription(3)}
										index: {@index.FormatValue()}
										value: {@value.FormatValue()}
									""");
							}
							
							this.Expectations.WasExceptionThrown = true;
							throw new global::Rocks.Exceptions.ExpectationException(
								$"""
								No handlers were found for {this.GetType().GetMemberDescription(3)}
									index: {@index.FormatValue()}
									value: {@value.FormatValue()}
								""");
						}
					}
					
					private global::IServiceCreateExpectations<T, TReturn> Expectations { get; }
				}
				
				public IServiceCreateExpectations() => this.setups = new(this);
				
				internal global::IService<T, TReturn> Instance()
				{
					if (!this.WasInstanceInvoked)
					{
						this.WasInstanceInvoked = true;
						var @mock = new Mock(this);
						this.MockType = @mock.GetType();
						return @mock;
					}
					else
					{
						throw new global::Rocks.Exceptions.NewMockInstanceException("Can only create a new mock once.");
					}
				}
				
				internal static class Adornments
				{
					public interface IAdornmentsForIService<TAdornments>
						: global::Rocks.IAdornments<TAdornments>
						where TAdornments : IAdornmentsForIService<TAdornments>
					{ }
					
					public sealed class AdornmentsForHandler0
						: global::Rocks.Adornments<AdornmentsForHandler0, global::IServiceCreateExpectations<T, TReturn>.Handler0, global::System.Func<T>, T>, IAdornmentsForIService<AdornmentsForHandler0>
					{
						public AdornmentsForHandler0(global::IServiceCreateExpectations<T, TReturn>.Handler0 handler)
							: base(handler) { }
					}
					
					public sealed class AdornmentsForHandler1
						: global::Rocks.Adornments<AdornmentsForHandler1, global::IServiceCreateExpectations<T, TReturn>.Handler1, global::System.Action<T>>, IAdornmentsForIService<AdornmentsForHandler1>
					{
						public AdornmentsForHandler1(global::IServiceCreateExpectations<T, TReturn>.Handler1 handler)
							: base(handler) { }
					}
					
					public sealed class AdornmentsForHandler2
						: global::Rocks.Adornments<AdornmentsForHandler2, global::IServiceCreateExpectations<T, TReturn>.Handler2, global::System.Func<TReturn, TReturn>, TReturn>, IAdornmentsForIService<AdornmentsForHandler2>
					{
						public AdornmentsForHandler2(global::IServiceCreateExpectations<T, TReturn>.Handler2 handler)
							: base(handler) { }
					}
					
					public sealed class AdornmentsForHandler3
						: global::Rocks.Adornments<AdornmentsForHandler3, global::IServiceCreateExpectations<T, TReturn>.Handler3, global::System.Action<TReturn, TReturn>>, IAdornmentsForIService<AdornmentsForHandler3>
					{
						public AdornmentsForHandler3(global::IServiceCreateExpectations<T, TReturn>.Handler3 handler)
							: base(handler) { }
					}
				}
			}
			
			#pragma warning restore CS8618
			#pragma warning restore CS8633
			#pragma warning restore CS8714
			#pragma warning restore CS8775
			"""";

		var makeGeneratedCode =
			""""
			// <auto-generated/>
			
			#pragma warning disable CS8618
			#pragma warning disable CS8633
			#pragma warning disable CS8714
			#pragma warning disable CS8775
			
			#nullable enable
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			internal sealed class IServiceMakeExpectations<T, TReturn>
			{
				internal global::IService<T, TReturn> Instance()
				{
					return new Mock();
				}
				
				private sealed class Mock
					: global::IService<T, TReturn>
				{
					public Mock()
					{
					}
					
					public T Data
					{
						get => default!;
						set { }
					}
					
					public TReturn this[TReturn @index]
					{
						get => default!;
						set { }
					}
				}
			}
			
			#pragma warning restore CS8618
			#pragma warning restore CS8633
			#pragma warning restore CS8714
			#pragma warning restore CS8775
			
			"""";

		await TestAssistants.RunGeneratorAsync<RockGenerator>(code,
			[
				("IServiceT, TReturn_Rock_Create.g.cs", createGeneratedCode),
				("IServiceT, TReturn_Rock_Make.g.cs", makeGeneratedCode)
			],
			[]);
	}

	[Test]
	public static async Task GenerateWithConstraintsAsync()
	{
		var code =
			"""
			using Rocks;
			using System;
			
			[assembly: Rock(typeof(IService<,>), BuildType.Create | BuildType.Make)]
			
			#nullable enable

			public interface IService<T, TReturn>
				where T : class
				where TReturn : struct
			{
				TReturn Service(T data);
			}
			""";

		var createGeneratedCode =
			""""
			// <auto-generated/>
			
			#pragma warning disable CS8618
			#pragma warning disable CS8633
			#pragma warning disable CS8714
			#pragma warning disable CS8775
			
			#nullable enable
			
			using Rocks.Extensions;
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			internal sealed class IServiceCreateExpectations<T, TReturn>
				: global::Rocks.Expectations
				where T : class
				where TReturn : struct
			{
				private readonly global::IServiceCreateExpectations<T, TReturn>.SetupsExpectations setups;
				
				internal sealed class SetupsExpectations
				{
					private readonly global::IServiceCreateExpectations<T, TReturn> parent;
				
					internal SetupsExpectations(global::IServiceCreateExpectations<T, TReturn> parent) =>
						this.parent = parent;
				
					internal global::IServiceCreateExpectations<T, TReturn>.Adornments.AdornmentsForHandler0 Service(global::Rocks.Argument<T> @data)
					{
						global::Rocks.Exceptions.ExpectationException.ThrowIf(this.parent.WasInstanceInvoked);
						global::System.ArgumentNullException.ThrowIfNull(@data);
						
						var @handler = new global::IServiceCreateExpectations<T, TReturn>.Handler0
						{
							@data = @data,
						};
						
						if (this.parent.handlers0 is null) { this.parent.handlers0 = new(@handler); }
						else { this.parent.handlers0.Add(@handler); }
						return new(@handler);
					}
				}
				
				internal global::IServiceCreateExpectations<T, TReturn>.SetupsExpectations Setups => this.setups;
				
				internal sealed class Handler0
					: global::Rocks.Handler<global::System.Func<T, TReturn>, TReturn>
				{
					public global::Rocks.Argument<T> @data { get; set; }
				}
				private global::Rocks.Handlers<global::IServiceCreateExpectations<T, TReturn>.Handler0>? @handlers0;
				
				public override void Verify()
				{
					if (!this.WasInstanceInvoked)
					{
						throw new global::Rocks.Exceptions.VerificationException([$"An instance of global::IServiceCreateExpectations<T, TReturn> was never made."]);
					}
					else if (!this.WasExceptionThrown)
					{
						var failures = new global::System.Collections.Generic.List<string>();
				
						if (this.handlers0 is not null) { failures.AddRange(this.Verify(this.handlers0, 0)); }
				
						if (failures.Count > 0)
						{
							throw new global::Rocks.Exceptions.VerificationException(failures);
						}
					}
				}
				
				private sealed class Mock
					: global::IService<T, TReturn>
				{
					public Mock(global::IServiceCreateExpectations<T, TReturn> @expectations)
					{
						this.Expectations = @expectations;
					}
					
					[global::Rocks.MemberIdentifier(0)]
					public TReturn Service(T @data)
					{
						if (this.Expectations.handlers0 is not null)
						{
							foreach (var @handler in this.Expectations.handlers0)
							{
								if (@handler.@data.IsValid(@data!))
								{
									@handler.CallCount++;
									var @result = @handler.Callback is not null ?
										@handler.Callback(@data!) : @handler.ReturnValue;
									return @result!;
								}
							}
							
							this.Expectations.WasExceptionThrown = true;
							throw new global::Rocks.Exceptions.ExpectationException(
								$"""
								No handlers match for {this.GetType().GetMemberDescription(0)}
									data: {@data.FormatValue()}
								""");
						}
						
						this.Expectations.WasExceptionThrown = true;
						throw new global::Rocks.Exceptions.ExpectationException(
							$"""
							No handlers were found for {this.GetType().GetMemberDescription(0)}
								data: {@data.FormatValue()}
							""");
					}
					
					private global::IServiceCreateExpectations<T, TReturn> Expectations { get; }
				}
				
				public IServiceCreateExpectations() => this.setups = new(this);
				
				internal global::IService<T, TReturn> Instance()
				{
					if (!this.WasInstanceInvoked)
					{
						this.WasInstanceInvoked = true;
						var @mock = new Mock(this);
						this.MockType = @mock.GetType();
						return @mock;
					}
					else
					{
						throw new global::Rocks.Exceptions.NewMockInstanceException("Can only create a new mock once.");
					}
				}
				
				internal static class Adornments
				{
					public interface IAdornmentsForIService<TAdornments>
						: global::Rocks.IAdornments<TAdornments>
						where TAdornments : IAdornmentsForIService<TAdornments>
					{ }
					
					public sealed class AdornmentsForHandler0
						: global::Rocks.Adornments<AdornmentsForHandler0, global::IServiceCreateExpectations<T, TReturn>.Handler0, global::System.Func<T, TReturn>, TReturn>, IAdornmentsForIService<AdornmentsForHandler0>
					{
						public AdornmentsForHandler0(global::IServiceCreateExpectations<T, TReturn>.Handler0 handler)
							: base(handler) { }
					}
				}
			}
			
			#pragma warning restore CS8618
			#pragma warning restore CS8633
			#pragma warning restore CS8714
			#pragma warning restore CS8775
			"""";

		var makeGeneratedCode =
			""""
			// <auto-generated/>
			
			#pragma warning disable CS8618
			#pragma warning disable CS8633
			#pragma warning disable CS8714
			#pragma warning disable CS8775
			
			#nullable enable
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			internal sealed class IServiceMakeExpectations<T, TReturn>
				where T : class
				where TReturn : struct
			{
				internal global::IService<T, TReturn> Instance()
				{
					return new Mock();
				}
				
				private sealed class Mock
					: global::IService<T, TReturn>
				{
					public Mock()
					{
					}
					
					public TReturn Service(T @data)
					{
						return default!;
					}
				}
			}
			
			#pragma warning restore CS8618
			#pragma warning restore CS8633
			#pragma warning restore CS8714
			#pragma warning restore CS8775
			
			"""";

		await TestAssistants.RunGeneratorAsync<RockGenerator>(code,
			[
				("IServiceT, TReturn_Rock_Create.g.cs", createGeneratedCode),
				("IServiceT, TReturn_Rock_Make.g.cs", makeGeneratedCode)
			],
			[]);
	}

	[Test]
	public static async Task GenerateWithMultipleCollisionsAsync()
	{
		var code =
			"""
			using Rocks;
			using System;
			using System.Linq.Expressions;
						
			[assembly: Rock(typeof(IHasTypeConverterOptions<,>), BuildType.Create | BuildType.Make)]
			
			#nullable enable

			public interface IHasMapOptions<TClass, TMember> { }

			public interface IHasMap<TClass>
			{
				IHasMapOptions<TClass, TMember> Map<TMember>(Expression<Func<TClass, TMember>> expression, bool useExistingMap = true);
			}

			public interface IHasTypeConverterOptions<TClass, TMember>
				: IHasMap<TClass>
			{ }
			""";

		var createGeneratedCode =
			""""
			// <auto-generated/>
			
			#pragma warning disable CS8618
			#pragma warning disable CS8633
			#pragma warning disable CS8714
			#pragma warning disable CS8775
			
			#nullable enable
			
			using Rocks.Extensions;
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			internal sealed class IHasTypeConverterOptionsCreateExpectations<TClass, TMember>
				: global::Rocks.Expectations
			{
				private readonly global::IHasTypeConverterOptionsCreateExpectations<TClass, TMember>.SetupsExpectations setups;
				
				internal sealed class SetupsExpectations
				{
					private readonly global::IHasTypeConverterOptionsCreateExpectations<TClass, TMember> parent;
				
					internal SetupsExpectations(global::IHasTypeConverterOptionsCreateExpectations<TClass, TMember> parent) =>
						this.parent = parent;
				
					internal global::IHasTypeConverterOptionsCreateExpectations<TClass, TMember>.Adornments.AdornmentsForHandler0<TMember1> Map<TMember1>(global::Rocks.Argument<global::System.Linq.Expressions.Expression<global::System.Func<TClass, TMember1>>> @expression, global::Rocks.Argument<bool> @useExistingMap)
					{
						global::Rocks.Exceptions.ExpectationException.ThrowIf(this.parent.WasInstanceInvoked);
						global::System.ArgumentNullException.ThrowIfNull(@expression);
						global::System.ArgumentNullException.ThrowIfNull(@useExistingMap);
						
						var @handler = new global::IHasTypeConverterOptionsCreateExpectations<TClass, TMember>.Handler0<TMember1>
						{
							@expression = @expression,
							@useExistingMap = @useExistingMap.Transform(true),
						};
						
						if (this.parent.handlers0 is null) { this.parent.handlers0 = new(@handler); }
						else { this.parent.handlers0.Add(@handler); }
						return new(@handler);
					}
					
					internal global::IHasTypeConverterOptionsCreateExpectations<TClass, TMember>.Adornments.AdornmentsForHandler0<TMember1> Map<TMember1>(global::Rocks.Argument<global::System.Linq.Expressions.Expression<global::System.Func<TClass, TMember1>>> @expression, bool @useExistingMap = true) =>
						this.Map<TMember1>(@expression, global::Rocks.Arg.Is(@useExistingMap));
				}
				
				internal global::IHasTypeConverterOptionsCreateExpectations<TClass, TMember>.SetupsExpectations Setups => this.setups;
				
				internal sealed class Handler0<TMember1>
					: global::Rocks.Handler<global::System.Func<global::System.Linq.Expressions.Expression<global::System.Func<TClass, TMember1>>, bool, global::IHasMapOptions<TClass, TMember1>>, global::IHasMapOptions<TClass, TMember1>>
				{
					public global::Rocks.Argument<global::System.Linq.Expressions.Expression<global::System.Func<TClass, TMember1>>> @expression { get; set; }
					public global::Rocks.Argument<bool> @useExistingMap { get; set; }
				}
				private global::Rocks.Handlers<global::Rocks.Handler>? @handlers0;
				
				public override void Verify()
				{
					if (!this.WasInstanceInvoked)
					{
						throw new global::Rocks.Exceptions.VerificationException([$"An instance of global::IHasTypeConverterOptionsCreateExpectations<TClass, TMember> was never made."]);
					}
					else if (!this.WasExceptionThrown)
					{
						var failures = new global::System.Collections.Generic.List<string>();
				
						if (this.handlers0 is not null) { failures.AddRange(this.Verify(this.handlers0, 0)); }
				
						if (failures.Count > 0)
						{
							throw new global::Rocks.Exceptions.VerificationException(failures);
						}
					}
				}
				
				private sealed class Mock
					: global::IHasTypeConverterOptions<TClass, TMember>
				{
					public Mock(global::IHasTypeConverterOptionsCreateExpectations<TClass, TMember> @expectations)
					{
						this.Expectations = @expectations;
					}
					
					[global::Rocks.MemberIdentifier(0)]
					public global::IHasMapOptions<TClass, TMember1> Map<TMember1>(global::System.Linq.Expressions.Expression<global::System.Func<TClass, TMember1>> @expression, bool @useExistingMap = true)
					{
						if (this.Expectations.handlers0 is not null)
						{
							foreach (var @genericHandler in this.Expectations.handlers0)
							{
								if (@genericHandler is global::IHasTypeConverterOptionsCreateExpectations<TClass, TMember>.Handler0<TMember1> @handler)
								{
									if (@handler.@expression.IsValid(@expression!) &&
										@handler.@useExistingMap.IsValid(@useExistingMap!))
									{
										@handler.CallCount++;
										var @result = @handler.Callback is not null ?
											@handler.Callback(@expression!, @useExistingMap!) : @handler.ReturnValue;
										return @result!;
									}
								}
							}
							
							this.Expectations.WasExceptionThrown = true;
							throw new global::Rocks.Exceptions.ExpectationException(
								$"""
								No handlers match for {this.GetType().GetMemberDescription(0)}
									expression: {@expression.FormatValue()}
									useExistingMap: {@useExistingMap.FormatValue()}
								""");
						}
						
						this.Expectations.WasExceptionThrown = true;
						throw new global::Rocks.Exceptions.ExpectationException(
							$"""
							No handlers were found for {this.GetType().GetMemberDescription(0)}
								expression: {@expression.FormatValue()}
								useExistingMap: {@useExistingMap.FormatValue()}
							""");
					}
					
					private global::IHasTypeConverterOptionsCreateExpectations<TClass, TMember> Expectations { get; }
				}
				
				public IHasTypeConverterOptionsCreateExpectations() => this.setups = new(this);
				
				internal global::IHasTypeConverterOptions<TClass, TMember> Instance()
				{
					if (!this.WasInstanceInvoked)
					{
						this.WasInstanceInvoked = true;
						var @mock = new Mock(this);
						this.MockType = @mock.GetType();
						return @mock;
					}
					else
					{
						throw new global::Rocks.Exceptions.NewMockInstanceException("Can only create a new mock once.");
					}
				}
				
				internal static class Adornments
				{
					public interface IAdornmentsForIHasTypeConverterOptions<TAdornments>
						: global::Rocks.IAdornments<TAdornments>
						where TAdornments : IAdornmentsForIHasTypeConverterOptions<TAdornments>
					{ }
					
					public sealed class AdornmentsForHandler0<TMember1>
						: global::Rocks.Adornments<AdornmentsForHandler0<TMember1>, global::IHasTypeConverterOptionsCreateExpectations<TClass, TMember>.Handler0<TMember1>, global::System.Func<global::System.Linq.Expressions.Expression<global::System.Func<TClass, TMember1>>, bool, global::IHasMapOptions<TClass, TMember1>>, global::IHasMapOptions<TClass, TMember1>>, IAdornmentsForIHasTypeConverterOptions<AdornmentsForHandler0<TMember1>>
					{
						public AdornmentsForHandler0(global::IHasTypeConverterOptionsCreateExpectations<TClass, TMember>.Handler0<TMember1> handler)
							: base(handler) { }
					}
				}
			}
			
			#pragma warning restore CS8618
			#pragma warning restore CS8633
			#pragma warning restore CS8714
			#pragma warning restore CS8775
			"""";

		var makeGeneratedCode =
			""""
			// <auto-generated/>
			
			#pragma warning disable CS8618
			#pragma warning disable CS8633
			#pragma warning disable CS8714
			#pragma warning disable CS8775
			
			#nullable enable
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			internal sealed class IHasTypeConverterOptionsMakeExpectations<TClass, TMember>
			{
				internal global::IHasTypeConverterOptions<TClass, TMember> Instance()
				{
					return new Mock();
				}
				
				private sealed class Mock
					: global::IHasTypeConverterOptions<TClass, TMember>
				{
					public Mock()
					{
					}
					
					public global::IHasMapOptions<TClass, TMember1> Map<TMember1>(global::System.Linq.Expressions.Expression<global::System.Func<TClass, TMember1>> @expression, bool @useExistingMap = true)
					{
						return default!;
					}
				}
			}
			
			#pragma warning restore CS8618
			#pragma warning restore CS8633
			#pragma warning restore CS8714
			#pragma warning restore CS8775
			
			"""";

		await TestAssistants.RunGeneratorAsync<RockGenerator>(code,
			[
				("IHasTypeConverterOptionsTClass, TMember_Rock_Create.g.cs", createGeneratedCode),
				("IHasTypeConverterOptionsTClass, TMember_Rock_Make.g.cs", makeGeneratedCode)
			],
			[]);
	}

	[Test]
	public static async Task GenerateWithNameCollisionsInTypeParametersAsync()
	{
		var code =
			"""
			using Rocks;
			using System;
			using System.Threading.Tasks;
						
			[assembly: Rock(typeof(IExceptionConsumeContext<>), BuildType.Create | BuildType.Make)]
			
			#nullable enable

			public interface IStory
			{
				string GetContent();
			}

			public interface IContext
			{
				Task RespondAsync<T>(T message);
			}

			public interface IConsumeContext<out TStory>
				: IContext
				where TStory : class, IStory
			{
				Task SetCompleted();
			}

			public interface IExceptionConsumeContext<out T>
				: IConsumeContext<T>
				where T : class, IStory
			{
				Exception Exception { get; }
			}
			""";

		var createGeneratedCode =
			""""
			// <auto-generated/>
			
			#pragma warning disable CS8618
			#pragma warning disable CS8633
			#pragma warning disable CS8714
			#pragma warning disable CS8775
			
			#nullable enable
			
			using Rocks.Extensions;
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			internal sealed class IExceptionConsumeContextCreateExpectations<T>
				: global::Rocks.Expectations
				where T : class, global::IStory
			{
				private readonly global::IExceptionConsumeContextCreateExpectations<T>.SetupsExpectations setups;
				
				internal sealed class SetupsExpectations
				{
					private readonly global::IExceptionConsumeContextCreateExpectations<T> parent;
				
					internal SetupsExpectations(global::IExceptionConsumeContextCreateExpectations<T> parent) =>
						this.parent = parent;
				
					internal global::IExceptionConsumeContextCreateExpectations<T>.Adornments.AdornmentsForHandler0 SetCompleted()
					{
						global::Rocks.Exceptions.ExpectationException.ThrowIf(this.parent.WasInstanceInvoked);
						var handler = new global::IExceptionConsumeContextCreateExpectations<T>.Handler0();
						if (this.parent.handlers0 is null) { this.parent.handlers0 = new(handler); }
						else { this.parent.handlers0.Add(handler); }
						return new(handler);
					}
					
					internal global::IExceptionConsumeContextCreateExpectations<T>.Adornments.AdornmentsForHandler1<T1> RespondAsync<T1>(global::Rocks.Argument<T1> @message)
					{
						global::Rocks.Exceptions.ExpectationException.ThrowIf(this.parent.WasInstanceInvoked);
						global::System.ArgumentNullException.ThrowIfNull(@message);
						
						var @handler = new global::IExceptionConsumeContextCreateExpectations<T>.Handler1<T1>
						{
							@message = @message,
						};
						
						if (this.parent.handlers1 is null) { this.parent.handlers1 = new(@handler); }
						else { this.parent.handlers1.Add(@handler); }
						return new(@handler);
					}
					internal sealed class ExceptionPropertyExpectations
					{
						private readonly global::IExceptionConsumeContextCreateExpectations<T> parent;
					
						internal ExceptionPropertyExpectations(global::IExceptionConsumeContextCreateExpectations<T> parent) => 
							this.parent = parent;
					
						internal global::IExceptionConsumeContextCreateExpectations<T>.Adornments.AdornmentsForHandler2 Gets()
						{
							global::Rocks.Exceptions.ExpectationException.ThrowIf(this.parent.WasInstanceInvoked);
							var handler = new global::IExceptionConsumeContextCreateExpectations<T>.Handler2();
							if (this.parent.handlers2 is null) { this.parent.handlers2 = new(handler); }
							else { this.parent.handlers2.Add(handler); }
							return new(handler);
						}
					}
					
					internal global::IExceptionConsumeContextCreateExpectations<T>.SetupsExpectations.ExceptionPropertyExpectations Exception => new(this.parent);
					
				}
				
				internal global::IExceptionConsumeContextCreateExpectations<T>.SetupsExpectations Setups => this.setups;
				
				internal sealed class Handler0
					: global::Rocks.Handler<global::System.Func<global::System.Threading.Tasks.Task>, global::System.Threading.Tasks.Task>
				{ }
				private global::Rocks.Handlers<global::IExceptionConsumeContextCreateExpectations<T>.Handler0>? @handlers0;
				
				internal sealed class Handler1<T1>
					: global::Rocks.Handler<global::System.Func<T1, global::System.Threading.Tasks.Task>, global::System.Threading.Tasks.Task>
				{
					public global::Rocks.Argument<T1> @message { get; set; }
				}
				private global::Rocks.Handlers<global::Rocks.Handler>? @handlers1;
				
				internal sealed class Handler2
					: global::Rocks.Handler<global::System.Func<global::System.Exception>, global::System.Exception>
				{ }
				private global::Rocks.Handlers<global::IExceptionConsumeContextCreateExpectations<T>.Handler2>? @handlers2;
				
				public override void Verify()
				{
					if (!this.WasInstanceInvoked)
					{
						throw new global::Rocks.Exceptions.VerificationException([$"An instance of global::IExceptionConsumeContextCreateExpectations<T> was never made."]);
					}
					else if (!this.WasExceptionThrown)
					{
						var failures = new global::System.Collections.Generic.List<string>();
				
						if (this.handlers0 is not null) { failures.AddRange(this.Verify(this.handlers0, 0)); }
						if (this.handlers1 is not null) { failures.AddRange(this.Verify(this.handlers1, 1)); }
						if (this.handlers2 is not null) { failures.AddRange(this.Verify(this.handlers2, 2)); }
				
						if (failures.Count > 0)
						{
							throw new global::Rocks.Exceptions.VerificationException(failures);
						}
					}
				}
				
				private sealed class Mock
					: global::IExceptionConsumeContext<T>
				{
					public Mock(global::IExceptionConsumeContextCreateExpectations<T> @expectations)
					{
						this.Expectations = @expectations;
					}
					
					[global::Rocks.MemberIdentifier(0)]
					public global::System.Threading.Tasks.Task SetCompleted()
					{
						if (this.Expectations.handlers0 is not null)
						{
							var @handler = this.Expectations.handlers0.First;
							@handler.CallCount++;
							var @result = @handler.Callback is not null ?
								@handler.Callback() : @handler.ReturnValue;
							return @result!;
						}
						
						this.Expectations.WasExceptionThrown = true;
						throw new global::Rocks.Exceptions.ExpectationException(
							$"""
							No handlers were found for {this.GetType().GetMemberDescription(0)}
							""");
					}
					
					[global::Rocks.MemberIdentifier(1)]
					public global::System.Threading.Tasks.Task RespondAsync<T1>(T1 @message)
					{
						if (this.Expectations.handlers1 is not null)
						{
							foreach (var @genericHandler in this.Expectations.handlers1)
							{
								if (@genericHandler is global::IExceptionConsumeContextCreateExpectations<T>.Handler1<T1> @handler)
								{
									if (@handler.@message.IsValid(@message!))
									{
										@handler.CallCount++;
										var @result = @handler.Callback is not null ?
											@handler.Callback(@message!) : @handler.ReturnValue;
										return @result!;
									}
								}
							}
							
							this.Expectations.WasExceptionThrown = true;
							throw new global::Rocks.Exceptions.ExpectationException(
								$"""
								No handlers match for {this.GetType().GetMemberDescription(1)}
									message: {@message.FormatValue()}
								""");
						}
						
						this.Expectations.WasExceptionThrown = true;
						throw new global::Rocks.Exceptions.ExpectationException(
							$"""
							No handlers were found for {this.GetType().GetMemberDescription(1)}
								message: {@message.FormatValue()}
							""");
					}
					
					public global::System.Exception Exception
					{
						[global::Rocks.MemberIdentifier(2)]
						get
						{
							if (this.Expectations.handlers2 is not null)
							{
								var @handler = this.Expectations.handlers2.First;
								@handler.CallCount++;
								var @result = @handler.Callback is not null ?
									@handler.Callback() : @handler.ReturnValue;
								return @result!;
							}
							
							this.Expectations.WasExceptionThrown = true;
							throw new global::Rocks.Exceptions.ExpectationException(
								$"""
								No handlers match for {this.GetType().GetMemberDescription(2)}
								""");
						}
					}
					
					private global::IExceptionConsumeContextCreateExpectations<T> Expectations { get; }
				}
				
				public IExceptionConsumeContextCreateExpectations() => this.setups = new(this);
				
				internal global::IExceptionConsumeContext<T> Instance()
				{
					if (!this.WasInstanceInvoked)
					{
						this.WasInstanceInvoked = true;
						var @mock = new Mock(this);
						this.MockType = @mock.GetType();
						return @mock;
					}
					else
					{
						throw new global::Rocks.Exceptions.NewMockInstanceException("Can only create a new mock once.");
					}
				}
				
				internal static class Adornments
				{
					public interface IAdornmentsForIExceptionConsumeContext<TAdornments>
						: global::Rocks.IAdornments<TAdornments>
						where TAdornments : IAdornmentsForIExceptionConsumeContext<TAdornments>
					{ }
					
					public sealed class AdornmentsForHandler0
						: global::Rocks.Adornments<AdornmentsForHandler0, global::IExceptionConsumeContextCreateExpectations<T>.Handler0, global::System.Func<global::System.Threading.Tasks.Task>, global::System.Threading.Tasks.Task>, IAdornmentsForIExceptionConsumeContext<AdornmentsForHandler0>
					{
						public AdornmentsForHandler0(global::IExceptionConsumeContextCreateExpectations<T>.Handler0 handler)
							: base(handler) { }
					}
					
					public sealed class AdornmentsForHandler1<T1>
						: global::Rocks.Adornments<AdornmentsForHandler1<T1>, global::IExceptionConsumeContextCreateExpectations<T>.Handler1<T1>, global::System.Func<T1, global::System.Threading.Tasks.Task>, global::System.Threading.Tasks.Task>, IAdornmentsForIExceptionConsumeContext<AdornmentsForHandler1<T1>>
					{
						public AdornmentsForHandler1(global::IExceptionConsumeContextCreateExpectations<T>.Handler1<T1> handler)
							: base(handler) { }
					}
					
					public sealed class AdornmentsForHandler2
						: global::Rocks.Adornments<AdornmentsForHandler2, global::IExceptionConsumeContextCreateExpectations<T>.Handler2, global::System.Func<global::System.Exception>, global::System.Exception>, IAdornmentsForIExceptionConsumeContext<AdornmentsForHandler2>
					{
						public AdornmentsForHandler2(global::IExceptionConsumeContextCreateExpectations<T>.Handler2 handler)
							: base(handler) { }
					}
				}
			}
			
			#pragma warning restore CS8618
			#pragma warning restore CS8633
			#pragma warning restore CS8714
			#pragma warning restore CS8775
			"""";

		var makeGeneratedCode =
			""""
			// <auto-generated/>
			
			#pragma warning disable CS8618
			#pragma warning disable CS8633
			#pragma warning disable CS8714
			#pragma warning disable CS8775
			
			#nullable enable
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			internal sealed class IExceptionConsumeContextMakeExpectations<T>
				where T : class, global::IStory
			{
				internal global::IExceptionConsumeContext<T> Instance()
				{
					return new Mock();
				}
				
				private sealed class Mock
					: global::IExceptionConsumeContext<T>
				{
					public Mock()
					{
					}
					
					public global::System.Threading.Tasks.Task SetCompleted()
					{
						return global::System.Threading.Tasks.Task.CompletedTask;
					}
					
					public global::System.Threading.Tasks.Task RespondAsync<T1>(T1 @message)
					{
						return global::System.Threading.Tasks.Task.CompletedTask;
					}
					
					public global::System.Exception Exception
					{
						get => default!;
					}
				}
			}
			
			#pragma warning restore CS8618
			#pragma warning restore CS8633
			#pragma warning restore CS8714
			#pragma warning restore CS8775
			
			"""";

		await TestAssistants.RunGeneratorAsync<RockGenerator>(code,
			[
				("IExceptionConsumeContextT_Rock_Create.g.cs", createGeneratedCode),
				("IExceptionConsumeContextT_Rock_Make.g.cs", makeGeneratedCode)
			],
			[]);
	}

	[Test]
	public static async Task GenerateWhenConstraintsAndTypeCollisionExistAsync()
	{
		var code =
			"""
			using Rocks;
			using System;
			
			[assembly: Rock(typeof(IService<>), BuildType.Create | BuildType.Make)]
			
			#nullable enable

			public interface IValues
			{
				string Obtain<T>(T key) where T : class;
			}

			public interface IService<T>
				: IValues
			{
				string Service(T data);
			}
			""";

		var createGeneratedCode =
			""""
			// <auto-generated/>
			
			#pragma warning disable CS8618
			#pragma warning disable CS8633
			#pragma warning disable CS8714
			#pragma warning disable CS8775
			
			#nullable enable
			
			using Rocks.Extensions;
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			internal sealed class IServiceCreateExpectations<T>
				: global::Rocks.Expectations
			{
				private readonly global::IServiceCreateExpectations<T>.SetupsExpectations setups;
				
				internal sealed class SetupsExpectations
				{
					private readonly global::IServiceCreateExpectations<T> parent;
				
					internal SetupsExpectations(global::IServiceCreateExpectations<T> parent) =>
						this.parent = parent;
				
					internal global::IServiceCreateExpectations<T>.Adornments.AdornmentsForHandler0 Service(global::Rocks.Argument<T> @data)
					{
						global::Rocks.Exceptions.ExpectationException.ThrowIf(this.parent.WasInstanceInvoked);
						global::System.ArgumentNullException.ThrowIfNull(@data);
						
						var @handler = new global::IServiceCreateExpectations<T>.Handler0
						{
							@data = @data,
						};
						
						if (this.parent.handlers0 is null) { this.parent.handlers0 = new(@handler); }
						else { this.parent.handlers0.Add(@handler); }
						return new(@handler);
					}
					
					internal global::IServiceCreateExpectations<T>.Adornments.AdornmentsForHandler1<T1> Obtain<T1>(global::Rocks.Argument<T1> @key) where T1 : class
					{
						global::Rocks.Exceptions.ExpectationException.ThrowIf(this.parent.WasInstanceInvoked);
						global::System.ArgumentNullException.ThrowIfNull(@key);
						
						var @handler = new global::IServiceCreateExpectations<T>.Handler1<T1>
						{
							@key = @key,
						};
						
						if (this.parent.handlers1 is null) { this.parent.handlers1 = new(@handler); }
						else { this.parent.handlers1.Add(@handler); }
						return new(@handler);
					}
				}
				
				internal global::IServiceCreateExpectations<T>.SetupsExpectations Setups => this.setups;
				
				internal sealed class Handler0
					: global::Rocks.Handler<global::System.Func<T, string>, string>
				{
					public global::Rocks.Argument<T> @data { get; set; }
				}
				private global::Rocks.Handlers<global::IServiceCreateExpectations<T>.Handler0>? @handlers0;
				
				internal sealed class Handler1<T1>
					: global::Rocks.Handler<global::System.Func<T1, string>, string>
					where T1 : class
				{
					public global::Rocks.Argument<T1> @key { get; set; }
				}
				private global::Rocks.Handlers<global::Rocks.Handler>? @handlers1;
				
				public override void Verify()
				{
					if (!this.WasInstanceInvoked)
					{
						throw new global::Rocks.Exceptions.VerificationException([$"An instance of global::IServiceCreateExpectations<T> was never made."]);
					}
					else if (!this.WasExceptionThrown)
					{
						var failures = new global::System.Collections.Generic.List<string>();
				
						if (this.handlers0 is not null) { failures.AddRange(this.Verify(this.handlers0, 0)); }
						if (this.handlers1 is not null) { failures.AddRange(this.Verify(this.handlers1, 1)); }
				
						if (failures.Count > 0)
						{
							throw new global::Rocks.Exceptions.VerificationException(failures);
						}
					}
				}
				
				private sealed class Mock
					: global::IService<T>
				{
					public Mock(global::IServiceCreateExpectations<T> @expectations)
					{
						this.Expectations = @expectations;
					}
					
					[global::Rocks.MemberIdentifier(0)]
					public string Service(T @data)
					{
						if (this.Expectations.handlers0 is not null)
						{
							foreach (var @handler in this.Expectations.handlers0)
							{
								if (@handler.@data.IsValid(@data!))
								{
									@handler.CallCount++;
									var @result = @handler.Callback is not null ?
										@handler.Callback(@data!) : @handler.ReturnValue;
									return @result!;
								}
							}
							
							this.Expectations.WasExceptionThrown = true;
							throw new global::Rocks.Exceptions.ExpectationException(
								$"""
								No handlers match for {this.GetType().GetMemberDescription(0)}
									data: {@data.FormatValue()}
								""");
						}
						
						this.Expectations.WasExceptionThrown = true;
						throw new global::Rocks.Exceptions.ExpectationException(
							$"""
							No handlers were found for {this.GetType().GetMemberDescription(0)}
								data: {@data.FormatValue()}
							""");
					}
					
					[global::Rocks.MemberIdentifier(1)]
					public string Obtain<T1>(T1 @key)
						where T1 : class
					{
						if (this.Expectations.handlers1 is not null)
						{
							foreach (var @genericHandler in this.Expectations.handlers1)
							{
								if (@genericHandler is global::IServiceCreateExpectations<T>.Handler1<T1> @handler)
								{
									if (@handler.@key.IsValid(@key!))
									{
										@handler.CallCount++;
										var @result = @handler.Callback is not null ?
											@handler.Callback(@key!) : @handler.ReturnValue;
										return @result!;
									}
								}
							}
							
							this.Expectations.WasExceptionThrown = true;
							throw new global::Rocks.Exceptions.ExpectationException(
								$"""
								No handlers match for {this.GetType().GetMemberDescription(1)}
									key: {@key.FormatValue()}
								""");
						}
						
						this.Expectations.WasExceptionThrown = true;
						throw new global::Rocks.Exceptions.ExpectationException(
							$"""
							No handlers were found for {this.GetType().GetMemberDescription(1)}
								key: {@key.FormatValue()}
							""");
					}
					
					private global::IServiceCreateExpectations<T> Expectations { get; }
				}
				
				public IServiceCreateExpectations() => this.setups = new(this);
				
				internal global::IService<T> Instance()
				{
					if (!this.WasInstanceInvoked)
					{
						this.WasInstanceInvoked = true;
						var @mock = new Mock(this);
						this.MockType = @mock.GetType();
						return @mock;
					}
					else
					{
						throw new global::Rocks.Exceptions.NewMockInstanceException("Can only create a new mock once.");
					}
				}
				
				internal static class Adornments
				{
					public interface IAdornmentsForIService<TAdornments>
						: global::Rocks.IAdornments<TAdornments>
						where TAdornments : IAdornmentsForIService<TAdornments>
					{ }
					
					public sealed class AdornmentsForHandler0
						: global::Rocks.Adornments<AdornmentsForHandler0, global::IServiceCreateExpectations<T>.Handler0, global::System.Func<T, string>, string>, IAdornmentsForIService<AdornmentsForHandler0>
					{
						public AdornmentsForHandler0(global::IServiceCreateExpectations<T>.Handler0 handler)
							: base(handler) { }
					}
					
					public sealed class AdornmentsForHandler1<T1>
						: global::Rocks.Adornments<AdornmentsForHandler1<T1>, global::IServiceCreateExpectations<T>.Handler1<T1>, global::System.Func<T1, string>, string>, IAdornmentsForIService<AdornmentsForHandler1<T1>> where T1 : class
					{
						public AdornmentsForHandler1(global::IServiceCreateExpectations<T>.Handler1<T1> handler)
							: base(handler) { }
					}
				}
			}
			
			#pragma warning restore CS8618
			#pragma warning restore CS8633
			#pragma warning restore CS8714
			#pragma warning restore CS8775
			"""";

		var makeGeneratedCode =
			""""
			// <auto-generated/>
			
			#pragma warning disable CS8618
			#pragma warning disable CS8633
			#pragma warning disable CS8714
			#pragma warning disable CS8775
			
			#nullable enable
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			internal sealed class IServiceMakeExpectations<T>
			{
				internal global::IService<T> Instance()
				{
					return new Mock();
				}
				
				private sealed class Mock
					: global::IService<T>
				{
					public Mock()
					{
					}
					
					public string Service(T @data)
					{
						return default!;
					}
					
					public string Obtain<T1>(T1 @key)
						where T1 : class
					{
						return default!;
					}
				}
			}
			
			#pragma warning restore CS8618
			#pragma warning restore CS8633
			#pragma warning restore CS8714
			#pragma warning restore CS8775
			
			"""";

		await TestAssistants.RunGeneratorAsync<RockGenerator>(code,
			[
				("IServiceT_Rock_Create.g.cs", createGeneratedCode),
				("IServiceT_Rock_Make.g.cs", makeGeneratedCode)
			],
			[]);
	}

	[Test]
	public static async Task GenerateWithRefStructAsync()
	{
		var code =
		  """
			using Rocks;
			using System;
			
			[assembly: Rock(typeof(IPixelOperations<>), BuildType.Create | BuildType.Make)]
			
			#nullable enable

			public interface IPixelOperations<TPixel> where TPixel : unmanaged
			{
				void Destructive(Span<TPixel> destinationPixels);
			}
			""";

		var createGeneratedCode =
			""""
			// <auto-generated/>
			
			#pragma warning disable CS8618
			#pragma warning disable CS8633
			#pragma warning disable CS8714
			#pragma warning disable CS8775
			
			#nullable enable
			
			using Rocks.Extensions;
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			internal sealed class IPixelOperationsCreateExpectations<TPixel>
				: global::Rocks.Expectations
				where TPixel : unmanaged
			{
				private readonly global::IPixelOperationsCreateExpectations<TPixel>.SetupsExpectations setups;
				
				internal sealed class SetupsExpectations
				{
					private readonly global::IPixelOperationsCreateExpectations<TPixel> parent;
				
					internal SetupsExpectations(global::IPixelOperationsCreateExpectations<TPixel> parent) =>
						this.parent = parent;
				
					internal global::IPixelOperationsCreateExpectations<TPixel>.Adornments.AdornmentsForHandler0 Destructive(global::Rocks.RefStructArgument<global::System.Span<TPixel>> @destinationPixels)
					{
						global::Rocks.Exceptions.ExpectationException.ThrowIf(this.parent.WasInstanceInvoked);
						global::System.ArgumentNullException.ThrowIfNull(@destinationPixels);
						
						var @handler = new global::IPixelOperationsCreateExpectations<TPixel>.Handler0
						{
							@destinationPixels = @destinationPixels,
						};
						
						if (this.parent.handlers0 is null) { this.parent.handlers0 = new(@handler); }
						else { this.parent.handlers0.Add(@handler); }
						return new(@handler);
					}
				}
				
				internal global::IPixelOperationsCreateExpectations<TPixel>.SetupsExpectations Setups => this.setups;
				
				internal sealed class Handler0
					: global::Rocks.Handler<global::System.Action<global::System.Span<TPixel>>>
				{
					public global::Rocks.RefStructArgument<global::System.Span<TPixel>> @destinationPixels { get; set; }
				}
				private global::Rocks.Handlers<global::IPixelOperationsCreateExpectations<TPixel>.Handler0>? @handlers0;
				
				public override void Verify()
				{
					if (!this.WasInstanceInvoked)
					{
						throw new global::Rocks.Exceptions.VerificationException([$"An instance of global::IPixelOperationsCreateExpectations<TPixel> was never made."]);
					}
					else if (!this.WasExceptionThrown)
					{
						var failures = new global::System.Collections.Generic.List<string>();
				
						if (this.handlers0 is not null) { failures.AddRange(this.Verify(this.handlers0, 0)); }
				
						if (failures.Count > 0)
						{
							throw new global::Rocks.Exceptions.VerificationException(failures);
						}
					}
				}
				
				private sealed class Mock
					: global::IPixelOperations<TPixel>
				{
					public Mock(global::IPixelOperationsCreateExpectations<TPixel> @expectations)
					{
						this.Expectations = @expectations;
					}
					
					[global::Rocks.MemberIdentifier(0)]
					public void Destructive(global::System.Span<TPixel> @destinationPixels)
					{
						if (this.Expectations.handlers0 is not null)
						{
							var @foundMatch = false;
							
							foreach (var @handler in this.Expectations.handlers0)
							{
								if (@handler.@destinationPixels.IsValid(@destinationPixels!))
								{
									@foundMatch = true;
									@handler.CallCount++;
									@handler.Callback?.Invoke(@destinationPixels!);
									break;
								}
							}
							
							if (!@foundMatch)
							{
								this.Expectations.WasExceptionThrown = true;
								throw new global::Rocks.Exceptions.ExpectationException(
									$"""
									No handlers match for {this.GetType().GetMemberDescription(0)}
										destinationPixels: <Not formattable>
									""");
							}
						}
						else
						{
							this.Expectations.WasExceptionThrown = true;
							throw new global::Rocks.Exceptions.ExpectationException(
								$"""
								No handlers were found for {this.GetType().GetMemberDescription(0)}
									destinationPixels: <Not formattable>
								""");
						}
					}
					
					private global::IPixelOperationsCreateExpectations<TPixel> Expectations { get; }
				}
				
				public IPixelOperationsCreateExpectations() => this.setups = new(this);
				
				internal global::IPixelOperations<TPixel> Instance()
				{
					if (!this.WasInstanceInvoked)
					{
						this.WasInstanceInvoked = true;
						var @mock = new Mock(this);
						this.MockType = @mock.GetType();
						return @mock;
					}
					else
					{
						throw new global::Rocks.Exceptions.NewMockInstanceException("Can only create a new mock once.");
					}
				}
				
				internal static class Adornments
				{
					public interface IAdornmentsForIPixelOperations<TAdornments>
						: global::Rocks.IAdornments<TAdornments>
						where TAdornments : IAdornmentsForIPixelOperations<TAdornments>
					{ }
					
					public sealed class AdornmentsForHandler0
						: global::Rocks.Adornments<AdornmentsForHandler0, global::IPixelOperationsCreateExpectations<TPixel>.Handler0, global::System.Action<global::System.Span<TPixel>>>, IAdornmentsForIPixelOperations<AdornmentsForHandler0>
					{
						public AdornmentsForHandler0(global::IPixelOperationsCreateExpectations<TPixel>.Handler0 handler)
							: base(handler) { }
					}
				}
			}
			
			#pragma warning restore CS8618
			#pragma warning restore CS8633
			#pragma warning restore CS8714
			#pragma warning restore CS8775
			"""";

		var makeGeneratedCode =
			""""
			// <auto-generated/>
			
			#pragma warning disable CS8618
			#pragma warning disable CS8633
			#pragma warning disable CS8714
			#pragma warning disable CS8775
			
			#nullable enable
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			internal sealed class IPixelOperationsMakeExpectations<TPixel>
				where TPixel : unmanaged
			{
				internal global::IPixelOperations<TPixel> Instance()
				{
					return new Mock();
				}
				
				private sealed class Mock
					: global::IPixelOperations<TPixel>
				{
					public Mock()
					{
					}
					
					public void Destructive(global::System.Span<TPixel> @destinationPixels)
					{
					}
				}
			}
			
			#pragma warning restore CS8618
			#pragma warning restore CS8633
			#pragma warning restore CS8714
			#pragma warning restore CS8775
			
			"""";

		await TestAssistants.RunGeneratorAsync<RockGenerator>(code,
			[
				("IPixelOperationsTPixel_Rock_Create.g.cs", createGeneratedCode),
				("IPixelOperationsTPixel_Rock_Make.g.cs", makeGeneratedCode)
			],
			[]);
	}

	[Test]
	public static async Task GenerateWithNullableReferenceAsync()
	{
		var code =
			"""
			using Rocks;
			using System;
			
			[assembly: Rock(typeof(INotification), BuildType.Create | BuildType.Make)]
			
			#nullable enable

			public interface INotification
			{
				void Similar<T>(string? key, T? value) where T : struct, Enum;
			}
			""";

		var createGeneratedCode =
			""""
			// <auto-generated/>
			
			#pragma warning disable CS8618
			#pragma warning disable CS8633
			#pragma warning disable CS8714
			#pragma warning disable CS8775
			
			#nullable enable
			
			using Rocks.Extensions;
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			internal sealed class INotificationCreateExpectations
				: global::Rocks.Expectations
			{
				private readonly global::INotificationCreateExpectations.SetupsExpectations setups;
				
				internal sealed class SetupsExpectations
				{
					private readonly global::INotificationCreateExpectations parent;
				
					internal SetupsExpectations(global::INotificationCreateExpectations parent) =>
						this.parent = parent;
				
					internal global::INotificationCreateExpectations.Adornments.AdornmentsForHandler0<T> Similar<T>(global::Rocks.Argument<string?> @key, global::Rocks.Argument<T?> @value) where T : struct, global::System.Enum
					{
						global::Rocks.Exceptions.ExpectationException.ThrowIf(this.parent.WasInstanceInvoked);
						global::System.ArgumentNullException.ThrowIfNull(@key);
						global::System.ArgumentNullException.ThrowIfNull(@value);
						
						var @handler = new global::INotificationCreateExpectations.Handler0<T>
						{
							@key = @key,
							@value = @value,
						};
						
						if (this.parent.handlers0 is null) { this.parent.handlers0 = new(@handler); }
						else { this.parent.handlers0.Add(@handler); }
						return new(@handler);
					}
				}
				
				internal global::INotificationCreateExpectations.SetupsExpectations Setups => this.setups;
				
				internal sealed class Handler0<T>
					: global::Rocks.Handler<global::System.Action<string?, T?>>
					where T : struct, global::System.Enum
				{
					public global::Rocks.Argument<string?> @key { get; set; }
					public global::Rocks.Argument<T?> @value { get; set; }
				}
				private global::Rocks.Handlers<global::Rocks.Handler>? @handlers0;
				
				public override void Verify()
				{
					if (!this.WasInstanceInvoked)
					{
						throw new global::Rocks.Exceptions.VerificationException([$"An instance of global::INotificationCreateExpectations was never made."]);
					}
					else if (!this.WasExceptionThrown)
					{
						var failures = new global::System.Collections.Generic.List<string>();
				
						if (this.handlers0 is not null) { failures.AddRange(this.Verify(this.handlers0, 0)); }
				
						if (failures.Count > 0)
						{
							throw new global::Rocks.Exceptions.VerificationException(failures);
						}
					}
				}
				
				private sealed class Mock
					: global::INotification
				{
					public Mock(global::INotificationCreateExpectations @expectations)
					{
						this.Expectations = @expectations;
					}
					
					[global::Rocks.MemberIdentifier(0)]
					public void Similar<T>(string? @key, T? @value)
						where T : struct, global::System.Enum
					{
						if (this.Expectations.handlers0 is not null)
						{
							var @foundMatch = false;
							
							foreach (var @genericHandler in this.Expectations.handlers0)
							{
								if (@genericHandler is global::INotificationCreateExpectations.Handler0<T> @handler)
								{
									if (@handler.@key.IsValid(@key!) &&
										@handler.@value.IsValid(@value!))
									{
										@foundMatch = true;
										@handler.CallCount++;
										@handler.Callback?.Invoke(@key!, @value!);
										break;
									}
								}
							}
							
							if (!@foundMatch)
							{
								this.Expectations.WasExceptionThrown = true;
								throw new global::Rocks.Exceptions.ExpectationException(
									$"""
									No handlers match for {this.GetType().GetMemberDescription(0)}
										key: {@key.FormatValue()}
										value: {@value.FormatValue()}
									""");
							}
						}
						else
						{
							this.Expectations.WasExceptionThrown = true;
							throw new global::Rocks.Exceptions.ExpectationException(
								$"""
								No handlers were found for {this.GetType().GetMemberDescription(0)}
									key: {@key.FormatValue()}
									value: {@value.FormatValue()}
								""");
						}
					}
					
					private global::INotificationCreateExpectations Expectations { get; }
				}
				
				public INotificationCreateExpectations() => this.setups = new(this);
				
				internal global::INotification Instance()
				{
					if (!this.WasInstanceInvoked)
					{
						this.WasInstanceInvoked = true;
						var @mock = new Mock(this);
						this.MockType = @mock.GetType();
						return @mock;
					}
					else
					{
						throw new global::Rocks.Exceptions.NewMockInstanceException("Can only create a new mock once.");
					}
				}
				
				internal static class Adornments
				{
					public interface IAdornmentsForINotification<TAdornments>
						: global::Rocks.IAdornments<TAdornments>
						where TAdornments : IAdornmentsForINotification<TAdornments>
					{ }
					
					public sealed class AdornmentsForHandler0<T>
						: global::Rocks.Adornments<AdornmentsForHandler0<T>, global::INotificationCreateExpectations.Handler0<T>, global::System.Action<string?, T?>>, IAdornmentsForINotification<AdornmentsForHandler0<T>> where T : struct, global::System.Enum
					{
						public AdornmentsForHandler0(global::INotificationCreateExpectations.Handler0<T> handler)
							: base(handler) { }
					}
				}
			}
			
			#pragma warning restore CS8618
			#pragma warning restore CS8633
			#pragma warning restore CS8714
			#pragma warning restore CS8775
			"""";

		var makeGeneratedCode =
			""""
			// <auto-generated/>
			
			#pragma warning disable CS8618
			#pragma warning disable CS8633
			#pragma warning disable CS8714
			#pragma warning disable CS8775
			
			#nullable enable
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			internal sealed class INotificationMakeExpectations
			{
				internal global::INotification Instance()
				{
					return new Mock();
				}
				
				private sealed class Mock
					: global::INotification
				{
					public Mock()
					{
					}
					
					public void Similar<T>(string? @key, T? @value)
						where T : struct, global::System.Enum
					{
					}
				}
			}
			
			#pragma warning restore CS8618
			#pragma warning restore CS8633
			#pragma warning restore CS8714
			#pragma warning restore CS8775
			
			"""";

		await TestAssistants.RunGeneratorAsync<RockGenerator>(code,
			[
				("INotification_Rock_Create.g.cs", createGeneratedCode),
				("INotification_Rock_Make.g.cs", makeGeneratedCode)
			],
			[]);
	}

	[Test]
	public static async Task GenerateWithNullableReferenceInReturnAsync()
	{
		var code =
			"""
			using Rocks;
			using System;
			using System.Collections.Generic;
						
			[assembly: Rock(typeof(IReaderWriter<,,>), BuildType.Create | BuildType.Make)]
			
			#nullable enable

			public sealed class Manager { }

			public interface IReaderWriter<TCollection, TConcreteCollection, TElement>
				where TCollection : IEnumerable<TElement?> where TElement : struct
			{
				IEnumerable<TElement?> FromJsonTyped(ref Manager manager, object? existingObject = null);
			}
			""";

		var createGeneratedCode =
			""""
			// <auto-generated/>
			
			#pragma warning disable CS8618
			#pragma warning disable CS8633
			#pragma warning disable CS8714
			#pragma warning disable CS8775
			
			#nullable enable
			
			using Rocks.Extensions;
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			internal sealed class IReaderWriterCreateExpectations<TCollection, TConcreteCollection, TElement>
				: global::Rocks.Expectations
				where TCollection : global::System.Collections.Generic.IEnumerable<TElement?>
				where TElement : struct
			{
				private readonly global::IReaderWriterCreateExpectations<TCollection, TConcreteCollection, TElement>.SetupsExpectations setups;
				
				internal sealed class SetupsExpectations
				{
					private readonly global::IReaderWriterCreateExpectations<TCollection, TConcreteCollection, TElement> parent;
				
					internal SetupsExpectations(global::IReaderWriterCreateExpectations<TCollection, TConcreteCollection, TElement> parent) =>
						this.parent = parent;
				
					internal global::IReaderWriterCreateExpectations<TCollection, TConcreteCollection, TElement>.Adornments.AdornmentsForHandler0 FromJsonTyped(global::Rocks.Argument<global::Manager> @manager, global::Rocks.Argument<object?> @existingObject)
					{
						global::Rocks.Exceptions.ExpectationException.ThrowIf(this.parent.WasInstanceInvoked);
						global::System.ArgumentNullException.ThrowIfNull(@manager);
						global::System.ArgumentNullException.ThrowIfNull(@existingObject);
						
						var @handler = new global::IReaderWriterCreateExpectations<TCollection, TConcreteCollection, TElement>.Handler0
						{
							@manager = @manager,
							@existingObject = @existingObject.Transform(null),
						};
						
						if (this.parent.handlers0 is null) { this.parent.handlers0 = new(@handler); }
						else { this.parent.handlers0.Add(@handler); }
						return new(@handler);
					}
					
					internal global::IReaderWriterCreateExpectations<TCollection, TConcreteCollection, TElement>.Adornments.AdornmentsForHandler0 FromJsonTyped(global::Rocks.Argument<global::Manager> @manager, object? @existingObject = null) =>
						this.FromJsonTyped(@manager, global::Rocks.Arg.Is(@existingObject));
				}
				
				internal global::IReaderWriterCreateExpectations<TCollection, TConcreteCollection, TElement>.SetupsExpectations Setups => this.setups;
				
				internal sealed class Handler0
					: global::Rocks.Handler<Handler0.CallbackForHandler, global::System.Collections.Generic.IEnumerable<TElement?>>
				{
					internal delegate global::System.Collections.Generic.IEnumerable<TElement?> CallbackForHandler(ref global::Manager @manager, object? @existingObject = null);
					public global::Rocks.Argument<global::Manager> @manager { get; set; }
					public global::Rocks.Argument<object?> @existingObject { get; set; }
				}
				private global::Rocks.Handlers<global::IReaderWriterCreateExpectations<TCollection, TConcreteCollection, TElement>.Handler0>? @handlers0;
				
				public override void Verify()
				{
					if (!this.WasInstanceInvoked)
					{
						throw new global::Rocks.Exceptions.VerificationException([$"An instance of global::IReaderWriterCreateExpectations<TCollection, TConcreteCollection, TElement> was never made."]);
					}
					else if (!this.WasExceptionThrown)
					{
						var failures = new global::System.Collections.Generic.List<string>();
				
						if (this.handlers0 is not null) { failures.AddRange(this.Verify(this.handlers0, 0)); }
				
						if (failures.Count > 0)
						{
							throw new global::Rocks.Exceptions.VerificationException(failures);
						}
					}
				}
				
				private sealed class Mock
					: global::IReaderWriter<TCollection, TConcreteCollection, TElement>
				{
					public Mock(global::IReaderWriterCreateExpectations<TCollection, TConcreteCollection, TElement> @expectations)
					{
						this.Expectations = @expectations;
					}
					
					[global::Rocks.MemberIdentifier(0)]
					public global::System.Collections.Generic.IEnumerable<TElement?> FromJsonTyped(ref global::Manager @manager, object? @existingObject = null)
					{
						if (this.Expectations.handlers0 is not null)
						{
							foreach (var @handler in this.Expectations.handlers0)
							{
								if (@handler.@manager.IsValid(@manager!) &&
									@handler.@existingObject.IsValid(@existingObject!))
								{
									@handler.CallCount++;
									var @result = @handler.Callback is not null ?
										@handler.Callback(ref @manager!, @existingObject!) : @handler.ReturnValue;
									return @result!;
								}
							}
							
							this.Expectations.WasExceptionThrown = true;
							throw new global::Rocks.Exceptions.ExpectationException(
								$"""
								No handlers match for {this.GetType().GetMemberDescription(0)}
									manager: {@manager.FormatValue()}
									existingObject: {@existingObject.FormatValue()}
								""");
						}
						
						this.Expectations.WasExceptionThrown = true;
						throw new global::Rocks.Exceptions.ExpectationException(
							$"""
							No handlers were found for {this.GetType().GetMemberDescription(0)}
								manager: {@manager.FormatValue()}
								existingObject: {@existingObject.FormatValue()}
							""");
					}
					
					private global::IReaderWriterCreateExpectations<TCollection, TConcreteCollection, TElement> Expectations { get; }
				}
				
				public IReaderWriterCreateExpectations() => this.setups = new(this);
				
				internal global::IReaderWriter<TCollection, TConcreteCollection, TElement> Instance()
				{
					if (!this.WasInstanceInvoked)
					{
						this.WasInstanceInvoked = true;
						var @mock = new Mock(this);
						this.MockType = @mock.GetType();
						return @mock;
					}
					else
					{
						throw new global::Rocks.Exceptions.NewMockInstanceException("Can only create a new mock once.");
					}
				}
				
				internal static class Adornments
				{
					public interface IAdornmentsForIReaderWriter<TAdornments>
						: global::Rocks.IAdornments<TAdornments>
						where TAdornments : IAdornmentsForIReaderWriter<TAdornments>
					{ }
					
					public sealed class AdornmentsForHandler0
						: global::Rocks.Adornments<AdornmentsForHandler0, global::IReaderWriterCreateExpectations<TCollection, TConcreteCollection, TElement>.Handler0, global::IReaderWriterCreateExpectations<TCollection, TConcreteCollection, TElement>.Handler0.CallbackForHandler, global::System.Collections.Generic.IEnumerable<TElement?>>, IAdornmentsForIReaderWriter<AdornmentsForHandler0>
					{
						public AdornmentsForHandler0(global::IReaderWriterCreateExpectations<TCollection, TConcreteCollection, TElement>.Handler0 handler)
							: base(handler) { }
					}
				}
			}
			
			#pragma warning restore CS8618
			#pragma warning restore CS8633
			#pragma warning restore CS8714
			#pragma warning restore CS8775
			"""";

		var makeGeneratedCode =
			""""
			// <auto-generated/>
			
			#pragma warning disable CS8618
			#pragma warning disable CS8633
			#pragma warning disable CS8714
			#pragma warning disable CS8775
			
			#nullable enable
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			internal sealed class IReaderWriterMakeExpectations<TCollection, TConcreteCollection, TElement>
				where TCollection : global::System.Collections.Generic.IEnumerable<TElement?>
				where TElement : struct
			{
				internal global::IReaderWriter<TCollection, TConcreteCollection, TElement> Instance()
				{
					return new Mock();
				}
				
				private sealed class Mock
					: global::IReaderWriter<TCollection, TConcreteCollection, TElement>
				{
					public Mock()
					{
					}
					
					public global::System.Collections.Generic.IEnumerable<TElement?> FromJsonTyped(ref global::Manager @manager, object? @existingObject = null)
					{
						return default!;
					}
				}
			}
			
			#pragma warning restore CS8618
			#pragma warning restore CS8633
			#pragma warning restore CS8714
			#pragma warning restore CS8775
			
			"""";

		await TestAssistants.RunGeneratorAsync<RockGenerator>(code,
			[
				("IReaderWriterTCollection, TConcreteCollection, TElement_Rock_Create.g.cs", createGeneratedCode),
				("IReaderWriterTCollection, TConcreteCollection, TElement_Rock_Make.g.cs", makeGeneratedCode)
			],
			[]);
	}

	[Test]
	public static async Task GenerateWithGenericNullableReferenceAsync()
	{
		var code =
			"""
			using Rocks;
			using System;
			
			[assembly: Rock(typeof(INotification<>), BuildType.Create | BuildType.Make)]
			
			#nullable enable

			public interface INotification<T>
			{
				bool Similar(INotification<T>? other);
			}
			""";

		var createGeneratedCode =
			""""
			// <auto-generated/>
			
			#pragma warning disable CS8618
			#pragma warning disable CS8633
			#pragma warning disable CS8714
			#pragma warning disable CS8775
			
			#nullable enable
			
			using Rocks.Extensions;
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			internal sealed class INotificationCreateExpectations<T>
				: global::Rocks.Expectations
			{
				private readonly global::INotificationCreateExpectations<T>.SetupsExpectations setups;
				
				internal sealed class SetupsExpectations
				{
					private readonly global::INotificationCreateExpectations<T> parent;
				
					internal SetupsExpectations(global::INotificationCreateExpectations<T> parent) =>
						this.parent = parent;
				
					internal global::INotificationCreateExpectations<T>.Adornments.AdornmentsForHandler0 Similar(global::Rocks.Argument<global::INotification<T>?> @other)
					{
						global::Rocks.Exceptions.ExpectationException.ThrowIf(this.parent.WasInstanceInvoked);
						global::System.ArgumentNullException.ThrowIfNull(@other);
						
						var @handler = new global::INotificationCreateExpectations<T>.Handler0
						{
							@other = @other,
						};
						
						if (this.parent.handlers0 is null) { this.parent.handlers0 = new(@handler); }
						else { this.parent.handlers0.Add(@handler); }
						return new(@handler);
					}
				}
				
				internal global::INotificationCreateExpectations<T>.SetupsExpectations Setups => this.setups;
				
				internal sealed class Handler0
					: global::Rocks.Handler<global::System.Func<global::INotification<T>?, bool>, bool>
				{
					public global::Rocks.Argument<global::INotification<T>?> @other { get; set; }
				}
				private global::Rocks.Handlers<global::INotificationCreateExpectations<T>.Handler0>? @handlers0;
				
				public override void Verify()
				{
					if (!this.WasInstanceInvoked)
					{
						throw new global::Rocks.Exceptions.VerificationException([$"An instance of global::INotificationCreateExpectations<T> was never made."]);
					}
					else if (!this.WasExceptionThrown)
					{
						var failures = new global::System.Collections.Generic.List<string>();
				
						if (this.handlers0 is not null) { failures.AddRange(this.Verify(this.handlers0, 0)); }
				
						if (failures.Count > 0)
						{
							throw new global::Rocks.Exceptions.VerificationException(failures);
						}
					}
				}
				
				private sealed class Mock
					: global::INotification<T>
				{
					public Mock(global::INotificationCreateExpectations<T> @expectations)
					{
						this.Expectations = @expectations;
					}
					
					[global::Rocks.MemberIdentifier(0)]
					public bool Similar(global::INotification<T>? @other)
					{
						if (this.Expectations.handlers0 is not null)
						{
							foreach (var @handler in this.Expectations.handlers0)
							{
								if (@handler.@other.IsValid(@other!))
								{
									@handler.CallCount++;
									var @result = @handler.Callback is not null ?
										@handler.Callback(@other!) : @handler.ReturnValue;
									return @result!;
								}
							}
							
							this.Expectations.WasExceptionThrown = true;
							throw new global::Rocks.Exceptions.ExpectationException(
								$"""
								No handlers match for {this.GetType().GetMemberDescription(0)}
									other: {@other.FormatValue()}
								""");
						}
						
						this.Expectations.WasExceptionThrown = true;
						throw new global::Rocks.Exceptions.ExpectationException(
							$"""
							No handlers were found for {this.GetType().GetMemberDescription(0)}
								other: {@other.FormatValue()}
							""");
					}
					
					private global::INotificationCreateExpectations<T> Expectations { get; }
				}
				
				public INotificationCreateExpectations() => this.setups = new(this);
				
				internal global::INotification<T> Instance()
				{
					if (!this.WasInstanceInvoked)
					{
						this.WasInstanceInvoked = true;
						var @mock = new Mock(this);
						this.MockType = @mock.GetType();
						return @mock;
					}
					else
					{
						throw new global::Rocks.Exceptions.NewMockInstanceException("Can only create a new mock once.");
					}
				}
				
				internal static class Adornments
				{
					public interface IAdornmentsForINotification<TAdornments>
						: global::Rocks.IAdornments<TAdornments>
						where TAdornments : IAdornmentsForINotification<TAdornments>
					{ }
					
					public sealed class AdornmentsForHandler0
						: global::Rocks.Adornments<AdornmentsForHandler0, global::INotificationCreateExpectations<T>.Handler0, global::System.Func<global::INotification<T>?, bool>, bool>, IAdornmentsForINotification<AdornmentsForHandler0>
					{
						public AdornmentsForHandler0(global::INotificationCreateExpectations<T>.Handler0 handler)
							: base(handler) { }
					}
				}
			}
			
			#pragma warning restore CS8618
			#pragma warning restore CS8633
			#pragma warning restore CS8714
			#pragma warning restore CS8775
			"""";

		var makeGeneratedCode =
			""""
			// <auto-generated/>
			
			#pragma warning disable CS8618
			#pragma warning disable CS8633
			#pragma warning disable CS8714
			#pragma warning disable CS8775
			
			#nullable enable
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			internal sealed class INotificationMakeExpectations<T>
			{
				internal global::INotification<T> Instance()
				{
					return new Mock();
				}
				
				private sealed class Mock
					: global::INotification<T>
				{
					public Mock()
					{
					}
					
					public bool Similar(global::INotification<T>? @other)
					{
						return default!;
					}
				}
			}
			
			#pragma warning restore CS8618
			#pragma warning restore CS8633
			#pragma warning restore CS8714
			#pragma warning restore CS8775
			
			"""";

		await TestAssistants.RunGeneratorAsync<RockGenerator>(code,
			[
				("INotificationT_Rock_Create.g.cs", createGeneratedCode),
				("INotificationT_Rock_Make.g.cs", makeGeneratedCode)
			],
			[]);
	}

	[Test]
	public static async Task GenerateWithMultipleNullableAnnotationsOnTypeAsync()
	{
		var code =
			"""
			using Rocks;
			using System;
			using System.Collections.Generic;
						
			[assembly: Rock(typeof(IWriter), BuildType.Create | BuildType.Make)]
			
			#nullable enable

			public interface IWriter
			{
				void WriteCollectionOfEnumValues<T>(string? key, IEnumerable<T?>? values) where T : struct, Enum;
			}
			""";

		var createGeneratedCode =
			""""
			// <auto-generated/>
			
			#pragma warning disable CS8618
			#pragma warning disable CS8633
			#pragma warning disable CS8714
			#pragma warning disable CS8775
			
			#nullable enable
			
			using Rocks.Extensions;
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			internal sealed class IWriterCreateExpectations
				: global::Rocks.Expectations
			{
				private readonly global::IWriterCreateExpectations.SetupsExpectations setups;
				
				internal sealed class SetupsExpectations
				{
					private readonly global::IWriterCreateExpectations parent;
				
					internal SetupsExpectations(global::IWriterCreateExpectations parent) =>
						this.parent = parent;
				
					internal global::IWriterCreateExpectations.Adornments.AdornmentsForHandler0<T> WriteCollectionOfEnumValues<T>(global::Rocks.Argument<string?> @key, global::Rocks.Argument<global::System.Collections.Generic.IEnumerable<T?>?> @values) where T : struct, global::System.Enum
					{
						global::Rocks.Exceptions.ExpectationException.ThrowIf(this.parent.WasInstanceInvoked);
						global::System.ArgumentNullException.ThrowIfNull(@key);
						global::System.ArgumentNullException.ThrowIfNull(@values);
						
						var @handler = new global::IWriterCreateExpectations.Handler0<T>
						{
							@key = @key,
							@values = @values,
						};
						
						if (this.parent.handlers0 is null) { this.parent.handlers0 = new(@handler); }
						else { this.parent.handlers0.Add(@handler); }
						return new(@handler);
					}
				}
				
				internal global::IWriterCreateExpectations.SetupsExpectations Setups => this.setups;
				
				internal sealed class Handler0<T>
					: global::Rocks.Handler<global::System.Action<string?, global::System.Collections.Generic.IEnumerable<T?>?>>
					where T : struct, global::System.Enum
				{
					public global::Rocks.Argument<string?> @key { get; set; }
					public global::Rocks.Argument<global::System.Collections.Generic.IEnumerable<T?>?> @values { get; set; }
				}
				private global::Rocks.Handlers<global::Rocks.Handler>? @handlers0;
				
				public override void Verify()
				{
					if (!this.WasInstanceInvoked)
					{
						throw new global::Rocks.Exceptions.VerificationException([$"An instance of global::IWriterCreateExpectations was never made."]);
					}
					else if (!this.WasExceptionThrown)
					{
						var failures = new global::System.Collections.Generic.List<string>();
				
						if (this.handlers0 is not null) { failures.AddRange(this.Verify(this.handlers0, 0)); }
				
						if (failures.Count > 0)
						{
							throw new global::Rocks.Exceptions.VerificationException(failures);
						}
					}
				}
				
				private sealed class Mock
					: global::IWriter
				{
					public Mock(global::IWriterCreateExpectations @expectations)
					{
						this.Expectations = @expectations;
					}
					
					[global::Rocks.MemberIdentifier(0)]
					public void WriteCollectionOfEnumValues<T>(string? @key, global::System.Collections.Generic.IEnumerable<T?>? @values)
						where T : struct, global::System.Enum
					{
						if (this.Expectations.handlers0 is not null)
						{
							var @foundMatch = false;
							
							foreach (var @genericHandler in this.Expectations.handlers0)
							{
								if (@genericHandler is global::IWriterCreateExpectations.Handler0<T> @handler)
								{
									if (@handler.@key.IsValid(@key!) &&
										@handler.@values.IsValid(@values!))
									{
										@foundMatch = true;
										@handler.CallCount++;
										@handler.Callback?.Invoke(@key!, @values!);
										break;
									}
								}
							}
							
							if (!@foundMatch)
							{
								this.Expectations.WasExceptionThrown = true;
								throw new global::Rocks.Exceptions.ExpectationException(
									$"""
									No handlers match for {this.GetType().GetMemberDescription(0)}
										key: {@key.FormatValue()}
										values: {@values.FormatValue()}
									""");
							}
						}
						else
						{
							this.Expectations.WasExceptionThrown = true;
							throw new global::Rocks.Exceptions.ExpectationException(
								$"""
								No handlers were found for {this.GetType().GetMemberDescription(0)}
									key: {@key.FormatValue()}
									values: {@values.FormatValue()}
								""");
						}
					}
					
					private global::IWriterCreateExpectations Expectations { get; }
				}
				
				public IWriterCreateExpectations() => this.setups = new(this);
				
				internal global::IWriter Instance()
				{
					if (!this.WasInstanceInvoked)
					{
						this.WasInstanceInvoked = true;
						var @mock = new Mock(this);
						this.MockType = @mock.GetType();
						return @mock;
					}
					else
					{
						throw new global::Rocks.Exceptions.NewMockInstanceException("Can only create a new mock once.");
					}
				}
				
				internal static class Adornments
				{
					public interface IAdornmentsForIWriter<TAdornments>
						: global::Rocks.IAdornments<TAdornments>
						where TAdornments : IAdornmentsForIWriter<TAdornments>
					{ }
					
					public sealed class AdornmentsForHandler0<T>
						: global::Rocks.Adornments<AdornmentsForHandler0<T>, global::IWriterCreateExpectations.Handler0<T>, global::System.Action<string?, global::System.Collections.Generic.IEnumerable<T?>?>>, IAdornmentsForIWriter<AdornmentsForHandler0<T>> where T : struct, global::System.Enum
					{
						public AdornmentsForHandler0(global::IWriterCreateExpectations.Handler0<T> handler)
							: base(handler) { }
					}
				}
			}
			
			#pragma warning restore CS8618
			#pragma warning restore CS8633
			#pragma warning restore CS8714
			#pragma warning restore CS8775
			"""";

		var makeGeneratedCode =
			""""
			// <auto-generated/>
			
			#pragma warning disable CS8618
			#pragma warning disable CS8633
			#pragma warning disable CS8714
			#pragma warning disable CS8775
			
			#nullable enable
			
			[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
			internal sealed class IWriterMakeExpectations
			{
				internal global::IWriter Instance()
				{
					return new Mock();
				}
				
				private sealed class Mock
					: global::IWriter
				{
					public Mock()
					{
					}
					
					public void WriteCollectionOfEnumValues<T>(string? @key, global::System.Collections.Generic.IEnumerable<T?>? @values)
						where T : struct, global::System.Enum
					{
					}
				}
			}
			
			#pragma warning restore CS8618
			#pragma warning restore CS8633
			#pragma warning restore CS8714
			#pragma warning restore CS8775
			
			"""";

		await TestAssistants.RunGeneratorAsync<RockGenerator>(code,
			[
				("IWriter_Rock_Create.g.cs", createGeneratedCode),
				("IWriter_Rock_Make.g.cs", makeGeneratedCode)
			],
			[]);
	}
}